#+TITLE:     My Emacs Configuration
#+EMAIL:     harrybournis@gmail.com
#+AUTHOR:    Harry Bournis
#+STARTUP: content
#+TODO: TODO WAITING MAC_ONLY WINDOWS_ONLY LINUX_ONLY UNIX_ONLY NOT_WINDOWS NOT_MAC NOT_LINUX NOT_UNIX WORK_ONLY NOT_WORK DISABLED | DONE
#+LANGUAGE:  en
#+PROPERTY: header-args :tangle init.el :comments org

* Prerequisites
- [[http://geoff.greer.fm/2011/12/27/the-silver-searcher-better-than-ack][ag ("the silver searcher")]] for searching
- [[http://git-scm.com/][git]]
- [[https://www.gnupg.org/][gnupg]] for encryption
- [[http://www.latex-project.org/][latex]] and [[http://pygments.org/][pygments]] to pdf export with syntax highlighting
- [[http://aspell.net/][GNU aspell]] for spell checking
- [[https://github.com/julienXX/terminal-notifier][Terminal Notifier]] for notifications on Mac
- [[https://github.com/BurntSushi/ripgrep][rigprep]] for [[https://github.com/alphapapa/magit-todos][magit-todos]]

* Packages Setup
** Proxy settings
#+BEGIN_SRC emacs-lisp
  (if (and (boundp 'config/proxy-url) config/proxy-url)
      (setq url-proxy-services
            `(("no_proxy" . "^\\(localhost\\|10.*\\)")
              ("http"     . ,config/proxy-url)
              ("https"    . ,config/proxy-url))))
#+END_SRC
** straight.el

#+BEGIN_SRC emacs-lisp
  (setq straight-use-package-by-default t
        use-package-expand-minimally t
        use-package-always-ensure nil
        use-package-always-defer t
        straight-check-for-modifications nil
        site-run-file nil
        inhibit-compacting-font-caches t)

  (defvar bootstrap-version)
  (let ((bootstrap-file
         (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
        (bootstrap-version 6))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
          (url-retrieve-synchronously
           "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
           'silent 'inhibit-cookies)
        (goto-char (point-max))
        (eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))

  (straight-use-package 'use-package)
  (setq use-package-verbose t)
  (straight-use-package '(org :type built-in))
#+END_SRC
** Security
#+BEGIN_SRC emacs-lisp
  (setq network-security-level 'high
        gnutls-algorithm-priority "normal:-vers-tls1.3"
        url-cookie-untrusted-urls '(".*"))
#+END_SRC
** IS-MAC/IS-LINUX
Determine whether the system is mac or linux

#+BEGIN_SRC emacs-lisp
  (defconst IS-MAC     (eq system-type 'darwin))
  (defconst IS-LINUX   (eq system-type 'gnu/linux))
  (defconst IS-WINDOWS (eq system-type 'windows-nt))
  (defconst WORK?      (if (getenv "WORK") t nil))
#+END_SRC
* Variables
Variables are set here that are used in the configuration below

#+BEGIN_SRC emacs-lisp
  (setq hbournis/org-main-file          "~/org/stuff.org"
        hbournis/org-book-file          "~/org/books.org"
        hbournis/org-mobile-file        "~/org/mobile_notes.org"
        hbournis/org-album-file         "~/org/album.org"
        hbournis/org-inbox-file         "~/org/Inbox.org"
        hbournis/org-work-file          "~/Documents/work.org"
        hbournis/org-journal-file       "~/org/journal.org.gpg"
        hbournis/recurring-file         "~/org/recurring.org"
        hbournis/bookmarks-file         "~/org/bookmarks.org"
        hbournis/private-bookmarks-file "~/org/private-bookmarks.org.gpg"
        hbournis/org-agenda-files       `(,hbournis/org-main-file
                                          ,hbournis/org-mobile-file
                                          ,hbournis/org-album-file
                                          ,hbournis/org-inbox-file
                                          ,hbournis/recurring-file
                                          ,hbournis/org-work-file)
        hbournis/default-font           "AurulentSansM Nerd Font Mono"
        hbournis/fallback-font          "Courier New"
        hbournis/unicode-font           "Unifont"
        hbournis/mac-font-size          "15"
        hbournis/windows-font-size      "11"
        hbournis/alternate-font-size    "11"
        theme                           'dark)
#+END_SRC
* Built-in Settings
** General
#+BEGIN_SRC emacs-lisp
  (setq inhibit-startup-screen t
        inhibit-startup-message t
        initial-scratch-message nil
        visible-bell nil
        apropos-do-all t                        ;; apropos commands perform more extensive searches than default
        large-file-warning-threshold 100000000  ;; warn only when opening files bigger than 100mb
        ring-bell-function
        ;; load-prefer-newer t
        (lambda ()
          (let ((orig-fg (face-foreground 'mode-line)))
            (set-face-foreground 'mode-line "#F2804F")
            (run-with-idle-timer 0.1 nil
                                 (lambda (fg) (set-face-foreground 'mode-line fg))
                                 orig-fg))))

  ;; have your emacs window always show your system-name and the full
  ;; path of the buffer you're currently editing
  (setq frame-title-format (list (format "%s %%s: %%j " (system-name)) '(buffer-file-name "%f" (dired-directory dired-directory "%b"))))

  (defun contextual-menubar (&optional frame)
    "Display the menubar in FRAME (default: selected frame) if on a
      graphical display, but hide it if in terminal."
    (interactive)
    (set-frame-parameter frame 'menu-bar-lines
                         (if (display-graphic-p frame)
                             1 0)))

  (add-hook 'after-make-frame-functions 'contextual-menubar)

  ;; replace yes/no questions with y/n
  (fset 'yes-or-no-p 'y-or-n-p)

  ;; show the empty lines at the end (bottom) of the buffer
  (toggle-indicate-empty-lines)

  ;; disable blinking cursor
  (blink-cursor-mode -1)

  ;; make sure that utf-8 is used everywhere.
  (set-terminal-coding-system  'utf-8)
  (set-keyboard-coding-system  'utf-8)
  (set-language-environment    'utf-8)
  (set-selection-coding-system 'utf-8)
  (setq locale-coding-system   'utf-8)
  (prefer-coding-system        'utf-8)
  (set-input-method nil)

  ;; always indent with spaces and 2 spaces
  (setq-default indent-tabs-mode  nil
                default-tab-width 2
                c-default-style "linux"
                c-basic-offset 2)

  ;; Scroll horizontally using mouse, touchpad and trackbar
  (setq mouse-wheel-tilt-scroll t)
  (setq display-line-numbers-type 'relative)
  (add-hook 'emacs-lisp-mode-hook 'display-line-numbers-mode)

  ;; set column number mode to true
  (column-number-mode t)

  ;; set cmd to control in mac
  (setq mac-command-modifier 'control)

  ;; Open .symlink files in sh-mode
  (add-to-list 'auto-mode-alist '("\\.symlink\\'" . sh-mode))

  ;; text wrapping at 80 columns by default (only text)
  (add-hook 'text-mode-hook 'auto-fill-mode)
  (setq-default fill-column 80)

  ;; cleanup whitespace on save
  (add-hook 'before-save-hook 'whitespace-cleanup)

  ;; set line spacing
  (setq-default line-spacing 0.2)

  ;; set the calendar to my country and city's calendar standards
  (setq-default calendar-week-start-day  1
                calendar-latitude        40.6
                calendar-longitude       22.9
                calendar-location-name   "Thessaloniki, Greece")

  ;; sets the default user's information properly.
  (setq user-full-name    "harry bournis"
        user-mail-address "harrybournis@gmail.com")

  ;; set a custom file for customize to keep init.el clean
  (setq custom-file "~/.emacs.d/custom.el")
  (load custom-file 'no-error)

  ;; save all backups to a single folder to avoid clutter
  (setq backup-directory-alist '(("." . "~/.emacs.d/etc/backups")))
  ;; disable backups for tramp
  (add-to-list 'backup-directory-alist (cons tramp-file-name-regexp nil))

  ;; Automatically refresh buffers that changed on disk
  (run-with-idle-timer 4 nil (lambda () (global-auto-revert-mode t)))

  ;; Undo/Redo changes in window configuration
  ;; Disabled in windows for performance
  (unless IS-WINDOWS
    (when (fboundp 'winner-mode)
      (winner-mode 1)))
#+END_SRC
** Encryption

#+BEGIN_SRC emacs-lisp
  ;; Don't require password each time on enryption with symmetric cyphers
  (setq epa-file-cache-passphrase-for-symmetric-encryption t)
  (setf epa-pinentry-mode 'loopback)

  (if IS-WINDOWS
      (progn
        (setq epg-gpg-home-directory "c:/Users/dfkjlsdf/AppData/Roaming/gnupg")
        (setq epg-gpg-program "c:/Program Files (x86)/GnuPG/bin/gpg.exe")
        (setq epg-gpgconf-program "c:/Program Files (x86)/GnuPG/bin/gpgconf.exe")))
#+END_SRC
** Terminal
#+BEGIN_SRC emacs-lisp
  ;; open fish for shell
  (setq explicit-shell-file-name "/usr/local/bin/zsh")
  (setenv "INSIDE_EMACS" "true")
#+END_SRC
*** open terminal below
#+BEGIN_SRC emacs-lisp
  (defun hbournis/open-terminal ()
    "Open a terminal.  If less than 3 windows, split and open it below.
  Otherwise open it in current window"
    (interactive)
    (if (< (count-windows) 3)
        (progn
          (unless (ignore-errors
                    (split-window-below))
            (progn
              (other-window 1)
              (split-window-below)))
          (other-window 1)))
    (if IS-WINDOWS
        (eshell)
      (ansi-term "zsh")))
#+END_SRC
*** Kill the buffer when term exits
#+BEGIN_SRC emacs-lisp
  ;; Kill window when ansi term exits
  ;; Source: https://github.com/redguardtoo/emacs.d/blob/master/lisp/init-term-mode.el
  ;; {{ @see http://emacs-journey.blogspot.com.au/2012/06/improving-ansi-term.html
  ;; kill the buffer when terminal is exited
  (defadvice term-sentinel (around my-advice-term-sentinel (proc msg))
    (if (memq (process-status proc) '(signal exit))
        (let ((buffer (process-buffer proc)))
          ad-do-it
            (kill-buffer-and-its-windows buffer))
      ad-do-it))
  (ad-activate 'term-sentinel)

  ;; Kill eshell window on exit
  ;; Source: https://stackoverflow.com/a/51867960
  (defun hbournis/delete-window ()
    (when (not (one-window-p))
      (delete-window)))

  (advice-add 'eshell-life-is-too-much :after 'hbournis/delete-window)
#+END_SRC
*** kill ansiterm without asking on exit
[[https://www.reddit.com/r/emacs/comments/9weic5/how_can_i_disable_ansiterm_prompt/e9k1ggd][Source]]
#+BEGIN_SRC emacs-lisp
  (add-hook 'term-exec-hook
        (lambda () (set-process-query-on-exit-flag (get-buffer-process (current-buffer)) nil)))
#+END_SRC
* Packages
** Common
*** dash
A modern [[https://github.com/magnars/dash.el][list]] API for Emacs.

#+begin_src emacs-lisp
  (use-package dash
    :straight t)
#+end_src
*** s
The long lost Emacs string manipulation [[https://github.com/magnars/s.el][library]].
#+begin_src emacs-lisp
  (use-package s
    :straight t)
#+end_src
*** org-mode
:PROPERTIES:
:VISIBILITY: folded
:END:
**** Org
#+BEGIN_SRC emacs-lisp
  (use-package org
    :straight t
    ;; :demand
    :config
    ;; Element cache makes it slow for some reason
    (setq org-element-cache-persistent nil)

    (add-to-list 'auto-mode-alist '("\\.orgtemplate\\'" . org-mode))

    ;; Copy link to clipboard on right click
    (define-key org-mouse-map (kbd "<mouse-3>")
      (lambda (event)
        (interactive "e")
        (goto-char (posn-point (event-start event)))
        (let* ((context
                (org-element-lineage (org-element-context) '(link) t))
               (type (org-element-type context))
               (value (org-element-property :value context)))
          (cond
           ((not type) (user-error "No link found"))
           ((>= (point)
                (save-excursion
                  (goto-char (org-element-property :end context))
                  (skip-chars-backward " \t")
                  (point)))
            (user-error "No link found"))
           ((eq type 'link) (hbournis/copy-to-clipboard (org-element-property :raw-link context)))
           (t (user-error "No link found"))))))

    (require 'ob-R)
    (require 'ob-sql)

    (ignore-errors (require 'org-tempo))

    (setq org-src-fontify-natively t               ;; Use language's syntax highlighting in code blocks
          org-src-tab-acts-natively t
          org-src-window-setup 'current-window     ;; Don't open new window when editing code blocks
          org-todo-keywords '((sequence "TODO(t)" "DOING(i!)" "WAITING(w@/!)" "SOMEDAY(s)" "|" "DONE(d!)" "CANCELED(c@)"))
          org-enforce-todo-dependencies t          ;; Parent can't be DONE until all children are

          org-startup-indented t                   ;; indent on startup
          org-indent-indentation-per-level 2       ;; indent each level by 2
          org-list-indent-offset 2                 ;; indent lists by 2
          org-display-inline-images t              ;; display images in org by default
          org-hide-emphasis-markers t              ;; hide bold, italics etc markers
          org-tags-column (- (window-total-width)) ;; make tags align at right window width
          org-latex-compiler "xelatex"             ;; the only one working for greek (i think?)
          org-log-into-drawer t                    ;; save logs in the drawer of current item
          org-clock-into-drawer "CLOCKING"         ;; name the clock drawer clocking
          org-log-reschedule (quote note)          ;; take a note in the log when rescheduling
          org-blank-before-new-entry (quote ((heading . t) (plain-list-item . auto)))
          org-babel-do-load-languages
          (quote (org-babel-load-languages (quote ((emacs-lisp . t)
                                                   (ruby . t)
                                                   (python . t)
                                                   (haskell . t)
                                                   (js . t)
                                                   (shell . t)
                                                   (R . t)
                                                   (prolog . t)
                                                   (clojurescript . t)
                                                   (plantuml . t)
                                                   (sql . t)
                                                   ))))
          org-export-backends (quote (ascii
                                      html
                                      icalendar
                                      latex
                                      md
                                      odt))
          org-modules '(ol-bbdb
                        ol-docview
                        ol-info
                        ol-w3m
                        ol-bibtex
                        org-protocol
                        org-collector
                        org-tempo)

          org-lowest-priority ?D
          org-default-priority ?D

          ;; custom colors for priorities
          org-priority-faces '((?A . (:foreground "red" :weight bold))
                               (?B . (:foreground "orange"))
                               (?C . (:foreground "yellow"))
                               (?D . (:foreground "green"))))

    (define-key org-mode-map (kbd "C-k") nil)

    ;; Show only the time when a note is added, instead of 'Note taken on..'
    (setq org-log-note-headings (assq-delete-all 'note org-log-note-headings))
    (add-to-list 'org-log-note-headings '(note . "%t"))

    (if (eq theme 'dark)
        (progn
          (set-face-attribute 'org-agenda-date-weekend nil
                              :weight 'normal)
          (set-face-attribute 'org-agenda-date          nil :height 1.1)
          (set-face-attribute 'org-agenda-date-today    nil :height 1.1)
          (set-face-attribute 'org-agenda-date-weekend  nil :height 1.1)
          (set-face-attribute 'org-agenda-structure     nil :height 1.1)
          (set-face-attribute 'org-level-1 nil
                              :foreground "#5c9ead")
          (set-face-attribute 'org-level-4 nil
                              :foreground "#f0a202")
          (set-face-attribute 'org-level-2 nil
                              :foreground "#bbbdf6")
          (set-face-attribute 'org-level-3 nil
                              :foreground "#f3b3a6")
          (set-face-attribute 'org-level-5 nil
                              :foreground "#cae7b9")
          (set-face-attribute 'org-level-6 nil
                              :foreground "#3ab795")

          (setq org-priority-faces '((?A . (:foreground "#ff6c6b" :weight bold))
                                     (?B . (:foreground "orange"))
                                     (?C . (:foreground "yellow"))
                                     (?D . (:foreground "green")))))
      (progn
        (setq org-todo-keyword-faces '(("TODO"        . (:foreground "#e74c3c" :weight bold))
                                       ("DOING"       . (:foreground "#2980b9" :weight bold))
                                       ("WAITING"     . (:foreground "#8e44ad" :weight bold))
                                       ("DONE"        . (:foreground "green" :weight bold))))
        (set-face-attribute 'org-checkbox nil
                            :box nil
                            :bold 'normal
                            :background nil)
        (set-face-attribute 'org-property-value nil
                            :foreground "black")
        (set-face-attribute 'org-agenda-date-weekend nil
                            :weight 'normal)
        )
      ))
#+END_SRC
**** Org-related packages
***** DISABLED org-bullets
Disabled on windows because it makes emacs extremely slow
#+BEGIN_SRC emacs-lisp
  (use-package org-bullets
    :straight t
    :config
    ;; Performance fix for windows
    ;; Source: https://github.com/sabof/org-bullets/issues/11#issuecomment-439228372
    (if IS-WINDOWS
        (setq inhibit-compacting-font-caches t))
    (setq org-bullets-bullet-list '("◉" "○" "✹" "◈" "⚇" "⚈" "⚉" "♁" "⊖" "⊗" "⊘"))
    (add-hook 'org-mode-hook (lambda () (org-bullets-mode t))))
#+END_SRC
***** org-collector
#+BEGIN_SRC emacs-lisp
  ;; Load org-collector
  (add-to-list 'load-path "~/.emacs.d/lisp/org-collector")
#+END_SRC
***** org-fancy-priorities
Display org priorities as custom strings

#+BEGIN_SRC emacs-lisp
  (use-package org-fancy-priorities
    :straight t
    :diminish
    :hook
    (org-mode . org-fancy-priorities-mode)
    :config
    (setq org-fancy-priorities-list '((?A . "❗")
                                      (?B . "⬆")
                                      (?C . "⬇")
                                      (?D . "☕")
                                      (?1 . "❗")
                                      (?2 . "⮬")
                                      (?3 . "⮮")
                                      (?4 . "☠"))))
#+END_SRC
***** org-capture-vars
#+BEGIN_SRC emacs-lisp
  ;; Load org-capture-vars
  (add-to-list 'load-path "~/.emacs.d/lisp/org-capture-vars")
  (with-eval-after-load 'org-capture (require 'org-capture-vars))
#+END_SRC
***** org-cliplink
Pretty-copy links from the browser to org with title instead of just url

#+BEGIN_SRC emacs-lisp
  (use-package org-cliplink
    :straight t
    :config
    (global-set-key (kbd "C-c p b") 'org-cliplink))
#+END_SRC
***** org-agenda-property
Display org properties in the agenda buffer

#+BEGIN_SRC emacs-lisp
  (use-package org-agenda-property
    :straight t)
#+END_SRC
***** org-reveal
[[https://github.com/yjwen/org-reveal][Presentations]]

Download reveal.js from [[https://revealjs.com/installation/#basic-setup][here]]. Set the org-reveal-root to the extracted folder (the root).

For code, swith to light theme before exporting, so that htmlize will use it on the code blocks.

You can also create speaker notes with a BEGIN_NOTES and END_NOTES
block. pressing "s" while on the presentation will create new browser window for notes

Use "#+ATTR_REVEAL: :frag t" to reveal parts of the page incrementally.

Some defaults:
#+begin_src
#+REVEAL_INIT_OPTIONS: margin: 0.1, minScale:0.2, maxScale:2.5, transition:'concave'
#+REVEAL_THEME: solarized
#+REVEAL_HEAD_PREAMBLE: <meta name="description" content="Org-Reveal Introduction.">
#+REVEAL_POSTAMBLE: <p> Created by yjwen. </p>
#+REVEAL_PLUGINS: (notes)
#+REVEAL_TITLE_SLIDE: <h1 class="title">%t</h1><h2 class="author">%a</h2><h3 class="email">%e</h3>
#+REVEAL_DEFAULT_FRAG_STYLE: roll-in
#+OPTIONS: toc:nil
#+OPTIONS: num:nil
#+end_src

#+BEGIN_SRC emacs-lisp
  (use-package ox-reveal
    :straight t
    :config
    ;; Set the root
    ;; (setq org-reveal-root "file:///Users/<user>/reveal.js-master")

    ;; Used for using emacs theme to highligh code
    (use-package htmlize
      :straight t)
    )
#+END_SRC
***** org-kanban
#+begin_src emacs-lisp
  (use-package org-kanban
    :straight t
    :hook (org-after-todo-state-change . org-update-all-dblocks))
#+end_src

***** orgtbl-aggregate
aggregate tables
#+begin_src emacs-lisp
  (use-package orgtbl-aggregate
    :straight t)
#+end_src
**** Org custom functions
#+BEGIN_SRC emacs-lisp
  ;; display week numbers in org calendar
  (copy-face font-lock-constant-face 'calendar-iso-week-face)
  (set-face-attribute 'calendar-iso-week-face nil :height 0.7)
  (setq calendar-intermonth-text
        '(propertize
          (format "%2d"
                  (car
                   (calendar-iso-from-absolute
                    (calendar-absolute-from-gregorian (list month day year)))))
          'font-lock-face 'calendar-iso-week-face))

  ;; Used for the protocol link see below
  (defun transform-square-brackets-to-round-ones(string-to-transform)
    "Transforms [ into ( and ] into ), other chars left unchanged."
    (concat
     (mapcar #'(lambda (c) (if (equal c ?\[) ?\( (if (equal c ?\]) ?\) c))) string-to-transform)))

  ;; Keep inherited tags on archived headings.
  ;; source: https://orgmode.org/worg/org-hacks.html
  (defadvice org-archive-subtree
      (before add-inherited-tags-before-org-archive-subtree activate)
    "add inherited tags before org-archive-subtree"
    (org-set-tags (org-get-tags)))
#+END_SRC
**** Org Capture
#+BEGIN_SRC emacs-lisp
  (setq hbournis/org-capture-file
        (if WORK?
            hbournis/org-work-file
          hbournis/org-inbox-file))

  (defun hbournis/validate-bookmark-link (url bookmark-file)
    (let ((clipboard url))
      (unless (s-starts-with? "http" clipboard)
        (progn (message "Clipboard does not contain a link.") (org-capture-kill)))
      (if (--any?
           (-contains?
            `(,clipboard
              ,(if (s-suffix? "/" clipboard)
                   (s-chop-suffix "/" clipboard)
                 (concat clipboard "/")))
            it)
           (org-map-entries (lambda () (org-entry-get nil "URL")) "web_bookmarks" `(,bookmark-file)))
          (progn (message "Link already exists.") (org-capture-kill)))))

  (defun hbournis/org-capture-bookmark (bookmark-file)
    "Validate that the link does not already exist in bookmarks."
    (interactive)
    (require 's)
    (hbournis/validate-bookmark-link (plist-get org-store-link-plist :link) bookmark-file)

    (defun hbournis/extract-host (url)
      (s-chop-prefix "www." (url-host (url-generic-parse-url url))))
    (defun hbournis/org-tag-from-host (url)
      (s-replace-all '(("." . "_") ("-" . "_")) (hbournis/extract-host url)))

    (goto-char (point-min))
    (re-search-forward "Web"))

  (defun hbournis/org-capture-bookmark-generic ()
    (hbournis/org-capture-bookmark hbournis/bookmarks-file))

  (defun hbournis/org-capture-bookmark-private ()
    (hbournis/org-capture-bookmark hbournis/private-bookmarks-file))

  ;; Bookmarks for Browser
  ;; Bookmark url: javascript: (() => { window.location.href = 'org-protocol://capture?' + new URLSearchParams({ template: 'l',url: window.location.href,title: document.title,body: window.getSelection() }); })();
  ;; Bookmark private url: javascript: (() => { window.location.href = 'org-protocol://capture?' + new URLSearchParams({ template: 'L',url: window.location.href,title: document.title,body: window.getSelection() }); })();
  (setq org-capture-templates
        `(
          ("l" "Link" entry
           (file+function hbournis/bookmarks-file hbournis/org-capture-bookmark-generic)
           (file "~/.emacs.d/org-templates/bookmark.orgtemplate")
           :prepend t
           :empty-lines-after 1
           :immediate-finish t)
          ("L" "Private Link" entry
           (file+function hbournis/private-bookmarks-file hbournis/org-capture-bookmark-private)
           (file "~/.emacs.d/org-templates/bookmark.orgtemplate")
           :prepend t
           :empty-lines-after 1
           :immediate-finish t)
          ("b" "Book" entry
           (file+headline hbournis/org-book-file ,(format "%s" (format-time-string "%Y")))
           (file "~/.emacs.d/org-templates/book.orgtemplate") :prepend t)
          ("w" "Work Note" entry
           (file+datetree hbournis/org-work-file)
           "** %U - %?")))
#+END_SRC
**** Org Agenda
#+BEGIN_SRC emacs-lisp
  (setq org-agenda-files (seq-filter 'file-exists-p hbournis/org-agenda-files)
        org-agenda-span 14                       ;; org agenda shows 10 days
        org-agenda-start-on-weekday nil          ;; org agenda does not start from beggining of week
        org-agenda-start-day "-2d"               ;; org agenda starts 2 days before today
        org-deadline-warning-days 3              ;; Number of days before expiration that it shows in agenda
        org-agenda-window-setup "only-frame"     ;; open a new full screen frame for org agenda
        org-agenda-block-separator 32            ;; disable seperator between agenda sections
        agenda-label-work-tag "Check & Refile"
        agenda-label-inbox "Inbox"
        agenda-label-calendar "10 days"
        agenda-label-priority-a "High-Priority"
        agenda-label-priority-b "Mid-Priority"
        agenda-label-priority-c "Low-Priority"
        agenda-label-priority-d "Other Todos"
        org-agenda-custom-commands '(("c" "Startup Agenda"
                                      (
                                       (tags "-work+.*"
                                             ((org-agenda-files `(,hbournis/org-inbox-file))
                                              (org-agenda-overriding-header agenda-label-inbox)))
                                       (agenda ""
                                               ((org-agenda-overriding-header agenda-label-calendar)))
                                       (tags "PRIORITY=\"A\""
                                             ((org-agenda-files (-remove (apply-partially #'equal hbournis/org-inbox-file)
                                                                         org-agenda-files))
                                              (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))
                                              (org-agenda-overriding-header agenda-label-priority-a)))
                                       (tags "PRIORITY=\"B\""
                                             ((org-agenda-files (-remove (apply-partially #'equal hbournis/org-inbox-file)
                                                                         org-agenda-files))
                                              (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))
                                              (org-agenda-overriding-header agenda-label-priority-b)))
                                       (tags "PRIORITY=\"C\""
                                             ((org-agenda-files (-remove (apply-partially #'equal hbournis/org-inbox-file)
                                                                         org-agenda-files))
                                              (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))
                                              (org-agenda-overriding-header agenda-label-priority-c)))
                                       ))
                                     ("w" "Work Agenda"
                                      (
                                       (tags-todo "capture_notes"
                                                  ((org-agenda-files `(,hbournis/org-work-file))
                                                   (org-agenda-overriding-header agenda-label-work-tag)))
                                       (agenda ""
                                               ((org-agenda-files `(,hbournis/org-work-file))
                                                (org-agenda-overriding-header agenda-label-calendar)))
                                       (tags "-capture_notes+PRIORITY=\"A\""
                                             ((org-agenda-files `(,hbournis/org-work-file))
                                              (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))
                                              (org-agenda-overriding-header agenda-label-priority-a)))
                                       (tags "-capture_notes+PRIORITY=\"B\""
                                             ((org-agenda-files `(,hbournis/org-work-file))
                                              (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))
                                              (org-agenda-overriding-header agenda-label-priority-b)))
                                       (tags "-capture_notes+PRIORITY=\"C\""
                                             ((org-agenda-files `(,hbournis/org-work-file))
                                              (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))
                                              (org-agenda-overriding-header agenda-label-priority-c)))))))
#+END_SRC
*** evil-mode
:PROPERTIES:
:VISIBILITY: folded
:END:
**** evil
Vim emulation. It is extended with various packages that provide existing Vim
functionalities. Bellow is a list of the Emacs package with the functionality
it provides in parentheses:

- [[https://github.com/emacs-evil/evil-surround][Evil Surround]]          (surround.vim)
- [[https://github.com/emacs-evil/evil-surround][Evil Lion]]              (vim-lion)
- [[https://github.com/redguardtoo/evil-matchit][Evil Matchit]]           (matchit.vim)
- [[https://github.com/cofi/evil-numbers][Evil Numbers]]           (increment/decrement binary, octal, decimal and hex numbers)
- [[https://github.com/redguardtoo/evil-nerd-commenter][Evil NERD Commenter]]    (The NERD Commenter)
- [[https://github.com/ninrod/evil-string-inflection][Evil String inflection]] (Convert between camelCase, kebab-case, snake_case and UPPER_CASE)

Although Evil mode does a wonderful job of emulating Vim keybinginds when
editing files, in the rest of the Emacs modes (and there are a lot) I find
myself stuck with Emacs' keybindings. Fortunately, there are a number of
packages that aim to bring Vim-sensible keybindings to the rest of them.

I use [[https://github.com/Somelauw/evil-org-mode][evil-org-mode]] mainly for the Org Agenda keybindings and the great
context-aware functionality it adds to the <return> key. For example, if you are
on a list item, pressing it will add a new list item bellow, including a
checkbox, if it is a checklist.. I found the rest of the keybindings distracting.

#+BEGIN_SRC emacs-lisp
  (use-package evil
    :straight t
    :demand t
    :init
    (setq evil-want-integration t
          evil-want-keybinding nil
          evil-undo-system 'undo-redo)

    (if (eq theme 'dark)
        (progn
          (setq evil-emacs-state-cursor    '("red" box)
                evil-normal-state-cursor   '("white" box)
                evil-visual-state-cursor   '("orange" box)
                evil-insert-state-cursor   '("cyan" box)
                evil-replace-state-cursor  '("red" box)
                evil-operator-state-cursor '("red" box))
          )
      (progn
        (setq evil-emacs-state-cursor    '("red" box)
              evil-normal-state-cursor   '("#1abc9c" box)
              evil-visual-state-cursor   '("orange" box)
              evil-insert-state-cursor   '("#9b59b6" box)
              evil-replace-state-cursor  '("red" box)
              evil-operator-state-cursor '("red" box))))
    :config
    (evil-mode t)
    ;; Scroll faster with C-e and C-y
    (define-key evil-normal-state-map "\C-e" (lambda () (interactive) (evil-scroll-line-down 2)))
    (define-key evil-normal-state-map "\C-y" (lambda () (interactive) (evil-scroll-line-up 2)))

    ;; g h takes you to the previous heading and
    ;; g H takes you to one heading up
    (evil-define-key 'motion org-mode-map
      (kbd "g h") 'org-previous-visible-heading
      (kbd "g H") 'outline-up-heading)

    ;; Save and quit ingoring mistakes from keeping shift pressed down
    (evil-ex-define-cmd "Q"  'evil-quit)
    (evil-ex-define-cmd "W"  'evil-write)
    (evil-ex-define-cmd "Wq" 'evil-save-and-close)
    (evil-ex-define-cmd "wQ" 'evil-save-and-close)
    (evil-ex-define-cmd "WQ" 'evil-save-and-close)

    ;; Does not replace clipboard copy with the text selected while in visual mode
    (fset 'evil-visual-update-x-selection 'ignore))
#+END_SRC

**** evil-collection
[[https://github.com/jojojames/evil-collection][Evil Collection]] aims to bring evil mode to every Emacs mode eventually. It has
keybindings for many modes, but I felt that I should enable it for a particular
mode only when it is needed.

#+BEGIN_SRC emacs-lisp
  (use-package evil-collection
    :straight t
    :demand t
    :after evil
    :init
    ;; check options in variable evil-collection--supported-modes
    (setq evil-collection-mode-list
          `(eshell
            calendar
            company
            custom
            cus-theme
            deadgrep
            debbugs
            debug
            diff-mode
            dired
            doc-view
            edebug
            ediff
            elfeed
            emms
            eval-sexp-fu
            flycheck
            ggtags
            git-timemachine
            help
            ibuffer
            image
            image+
            magit
            magit-todos
            neotree
            info
            man
            (package-menu package)
            (pdf pdf-view)
            (term term ansi-term multi-term)
            vdiff
            vc-annotate
            xref))
    :config
    (evil-collection-init))
#+END_SRC
**** evil-surround
#+BEGIN_SRC emacs-lisp
  (use-package evil-surround
    :straight t
    :demand t
    :commands (global-evil-surround-mode
               evil-surround-edit
               evil-Surround-edit
               evil-surround-region)
    :config
    (global-evil-surround-mode))
#+END_SRC
**** evil-lion
Indents to a similar level elements on similar lines e.g. all '=' in variable assignments
#+BEGIN_SRC emacs-lisp
  (use-package evil-lion
    :straight t
    :demand t
    :after evil
    :config
    (evil-lion-mode))
#+END_SRC
**** evil-matchit
Press % to move between opening and closing tag in any language
#+BEGIN_SRC emacs-lisp
  (use-package evil-matchit
    :straight t
    :demand t
    :after (evil)
    :config
    (global-evil-matchit-mode t))
#+END_SRC
**** DISABLED evil-numbers
Increment / decrement binary, octal, decimal and hex literals
#+BEGIN_SRC emacs-lisp
  (use-package evil-numbers
    :straight t
    :demand t
    :after evil
    :config
    (define-key evil-normal-state-map (kbd "C-c +") 'evil-numbers/inc-at-pt)
    (define-key evil-normal-state-map (kbd "C-c -") 'evil-numbers/dec-at-pt))
#+END_SRC
**** evil-nerd-commenter
Nerd commenter emulation
#+BEGIN_SRC emacs-lisp
  (use-package evil-nerd-commenter
    :straight t
    :commands (evilnc-comment-operator
               evilnc-inner-commenter
               evilnc-outer-commenter))
#+END_SRC
**** evil-org
Org mode key bindings for evil mode
#+BEGIN_SRC emacs-lisp
  (use-package evil-org
    :straight t
    :hook (org-mode . evil-org-mode)
    :diminish
    :config
    ;; (add-hook 'org-mode-hook 'evil-org-mode)
    (add-hook 'evil-org-mode-hook
              (lambda ()
                (evil-org-set-key-theme '(return))
                (require 'evil-org-agenda)
                (evil-org-agenda-set-keys))))
#+END_SRC
**** DISABLED evil-string-inflection
Changes case of variables (camelCase, kebab-case, snake_case and UPPER_CASE)
#+BEGIN_SRC emacs-lisp
  (use-package evil-string-inflection
    :straight t
    :demand t
    :after evil)
#+END_SRC
**** Greek Keybindings
Keybindings to allow moving around when writing in Greek

#+BEGIN_SRC emacs-lisp
  ;; Vim Movements
  (define-key evil-normal-state-map "κ" 'evil-previous-visual-line)
  (define-key evil-normal-state-map "ξ" 'evil-next-visual-line)
  (define-key evil-normal-state-map "λ" 'evil-forward-char)
  (define-key evil-normal-state-map "η" 'evil-backward-char)
  (define-key evil-normal-state-map "ς" 'evil-forward-word-begin)
  (define-key evil-normal-state-map "ε" 'evil-forward-word-end)
  (define-key evil-normal-state-map "β" 'evil-backward-word-end)
  (define-key evil-normal-state-map "ν" 'evil-search-next)
  (define-key evil-normal-state-map "Ν" 'evil-search-previous)
  (define-key evil-normal-state-map "γγ" 'evil-goto-first-line)
  (define-key evil-normal-state-map "Γ" 'evil-goto-line)

  ;; Vim Editing
  (define-key evil-normal-state-map "ι" 'evil-insert)
  (define-key evil-normal-state-map "Ι" 'evil-insert-line)
  (define-key evil-normal-state-map "θ" 'evil-undo)
  (define-key evil-normal-state-map "ω" 'evil-visual-char)
  (define-key evil-normal-state-map "Ω" 'evil-visual-line)
  (define-key evil-normal-state-map (kbd "C-ω") 'evil-visual-block)
  (define-key evil-normal-state-map (kbd "C-ο") 'evil-jump-backward)
  (define-key evil-normal-state-map (kbd "C-ρ") 'evil-redo)

  (define-key evil-normal-state-map "α" 'evil-append)
  (define-key evil-normal-state-map "Α" 'evil-append-line)
  (define-key evil-normal-state-map "ο" 'evil-open-below)
  (define-key evil-normal-state-map "Ο" 'evil-open-above)
  (define-key evil-normal-state-map "ρ" 'evil-replace)
  (define-key evil-normal-state-map "υ" 'evil-sp-yank)
  (define-key evil-normal-state-map "Υ" 'evil-sp-yank-line)
  (define-key evil-normal-state-map "δ" 'evil-sp-delete)
  (define-key evil-normal-state-map "Δ" 'evil-sp-delete-line)
  (define-key evil-normal-state-map "σ" 'evil-sp-substitute)
  (define-key evil-normal-state-map "Σ" 'evil-sp-change-whole-line)
  (define-key evil-normal-state-map "ψ" 'evil-sp-change)
  (define-key evil-normal-state-map "Ψ" 'evil-sp-change-line)
  (define-key evil-normal-state-map "χ" 'evil-sp-delete-char)
  (define-key evil-normal-state-map "Χ" 'evil-sp-backward-delete-char)
  (define-key evil-normal-state-map "π" 'evil-paste-after)
  (define-key evil-normal-state-map "Π" 'evil-paste-before)

  ;; Evil-ex commands
  (evil-ex-define-cmd "ς"  'evil-write)

  ;; Emacs Globals
  (define-key key-translation-map (kbd "C-ψ") (kbd "C-c"))
  (define-key key-translation-map (kbd "C-χ") (kbd "C-x"))
  (define-key key-translation-map (kbd "C-γ") (kbd "C-g"))
  (define-key key-translation-map (kbd "C-ε") (kbd "C-e"))
  (define-key key-translation-map (kbd "C-υ") (kbd "C-y"))
  (define-key key-translation-map (kbd "¨") (kbd ":"))
#+END_SRC
*** general.el
Improvement on evil-leader. Specify mutliple leaders.

#+BEGIN_SRC emacs-lisp
  (use-package general
    :straight t
    :demand t
    :config
    (setq general-override-states '(emacs
                                    hybrid
                                    normal
                                    visual
                                    motion
                                    operator))
    (general-evil-setup t)
    (general-override-mode)

    ;; Fix general not working in *Messages* buffer
    ;; Source: https://github.com/noctuid/general.el/issues/493
    (general-with 'evil
      (general-add-hook 'post-command-hook
                        (lambda (&rest _)
                          (when (eq major-mode 'messages-buffer-mode)
                            (evil-normalize-keymaps)
                            t))
                        nil
                        nil
                        #'identity))

    ;; In order for Space to work everywhere. "" nil is used to unbind it first.
    (general-create-definer basic-nav-leader :prefix "SPC" :keymaps 'override :states '(normal visual motion) :non-normal-prefix "C-SPC")

    (basic-nav-leader
      "" nil
      "f"         'consult-buffer
      "F"         'consult-buffer-other-window
      "ESC"       'keyboard-quit
      "x"         'execute-extended-command
      "k"         'windmove-up
      "j"         'windmove-down
      "l"         'windmove-right
      "h"         'windmove-left
      "K"         'split-window-below
      "J"         'split-window-below-and-switch
      "H"         'split-window-right
      "L"         'split-window-right-and-switch
      "0"         'delete-window
      "1"         'delete-other-windows
      "2"         'split-window-below-and-switch
      "3"         'split-window-right-and-switch
      "d"         'delete-window
      "|"         'toggle-window-split
      "p"         'consult-projectile-find-file
      "P"         'consult-projectile-switch-project
      "s"         'consult-ripgrep
      "="         'toggle-light-dark-theme
      "t"         'org-todo
      "ns"        'hbournis/create-scratch-buffer
      "c"         'hbournis/copy-filename-to-clipboard
      "RET"       'hbournis/generic-find-definition
      "w"         'hydra-window-deluxe-custom/body
      "<S-return>" (lambda () (interactive) (split-window-right-and-switch) (hbournis/generic-find-definition))
      "r"         (lambda () (interactive) (hbournis/call-with-prefix 'lsp-treemacs-references))
      "SPC"       (lambda () (interactive) (hbournis/open-org-file  hbournis/org-main-file))
      "a"         (lambda () (interactive) (hbournis/open-org-file hbournis/org-mobile-file))
      "!"         (lambda () (interactive) (load-file "~/.dotfiles/emacs.d.symlink/init.el"))
      "m"         (lambda () (interactive) (find-file "~/.dotfiles/emacs.d.symlink/init.org"))
      "i"         (lambda () (interactive) (hbournis/open-org-file hbournis/org-inbox-file))
      "z"         (lambda () (interactive) (hbournis/open-org-file hbournis/org-work-file)))

    (general-create-definer extra-tools-leader :prefix "'" :keymaps 'override :states '(normal visual treemacs))
    (extra-tools-leader
      "`"   'hbournis/open-terminal
      "g"   'magit-status
      "/"   'evilnc-comment-or-uncomment-lines             ; Un/Comment current line
      "["   'wrap-with-parens
      "]"   'sp-unwrap-sexp
      "\\"  'org-align-all-tags-right
      "fn"  'flycheck-next-error
      "fp"  'flycheck-previous-error
      "fl"  'flycheck-list-errors
      "i"   'org-toggle-inline-images
      "l"   'cider-ns-refresh
      "d"   'hbournis/generic-open-doc
      "c"   'hbournis/generic-show-repl
      "tf"  'hbournis/generic-run-test-file
      "tt"  'hbournis/generic-run-test-at-point
      "ta"  'hbournis/generic-run-test-all
      "m"   'hbournis/toggle-modeline
      "*"   (lambda() (interactive) (forward-char 1) (insert " ⭐")))

    (general-create-definer extra-tools-alternate-leader :prefix "' '" :keymaps 'override :states '(normal visual))
    (extra-tools-alternate-leader
      "/c"  'evilnc-copy-and-comment-lines                 ; Copy down and comment line
      "lv"  'org-cliplink
      "lp"  'hbournis/insert-url-as-org-link
      "ll"  'hbournis/org-make-word-link-from-clipboard
      "lc"  'hbournis-position-to-kill-ring
      "c"   'org-capture
      "gt"  'git-timemachine-toggle
      "gr"  'git-gutter:revert-hunk
      "gn"  'git-gutter:next-hunk
      "gp"  'git-gutter:previous-hunk
      "gb"  'magit-blame-echo
      "gh"  'magit-log-buffer-file
      "gm"  (lambda () (interactive) (magit-find-file-other-window "master" (format "%s" buffer-file-name)))
      "rf"  'rubocopfmt
      "rb"  'ruby-toggle-block
      "rr"  'projectile-rails-goto-routes
      "rt"  'projectile-rails-find-current-spec
      ))
#+END_SRC
*** magit
#+BEGIN_SRC emacs-lisp
  (use-package magit
    :straight t
    :config
    (with-eval-after-load 'magit (evil-collection-magit-init))

    (evil-define-minor-mode-key 'normal 'magit-blame-mode
      (kbd "<return>")  'magit-show-commit)

    (transient-append-suffix 'magit-push "-u"
      '(1 "=s" "Skip gitlab pipeline" "--push-option=ci.skip"))

    (setq magit-blame-echo-style 'headings)

    ;; (setq magit-git-executable "/usr/local/bin/git")
    (if (not (eq theme 'dark))
        (progn
          (set-face-attribute 'magit-section-highlight nil
                              :background "#dfe4ea")
          (set-face-attribute 'magit-section-heading nil
                              :foreground "#8E44AD")
          (set-face-attribute 'magit-branch-local nil
                              :foreground "#2980B9")
          (set-face-attribute 'magit-branch-remote nil
                              :foreground "#27AE60")
          (set-face-attribute 'magit-diff-context nil
                              :background "grey20"))))
#+END_SRC
*** smerge-mode
Easily resolve git conflicts [[https://github.com/alphapapa/unpackaged.el#smerge-mode][Source]]

#+BEGIN_SRC emacs-lisp
  (use-package smerge-mode
    :after hydra
    :hook (magit-diff-visit-file . (lambda ()
                                     (when smerge-mode
                                       (unpackaged/smerge-hydra/body))))
    :config
    (defhydra unpackaged/smerge-hydra
      (:color pink :hint nil :post (smerge-auto-leave))
      "
  ^Move^       ^Keep^               ^Diff^                 ^Other^
  ^^-----------^^-------------------^^---------------------^^-------
  _n_ext       _b_ase               _<_: upper/base        _C_ombine
  _p_rev       _u_pper              _=_: upper/lower       _r_esolve
  ^^           _l_ower              _>_: base/lower        _k_ill current
  ^^           _a_ll                _R_efine
  ^^           _RET_: current       _E_diff
  "
      ("n" smerge-next)
      ("p" smerge-prev)
      ("b" smerge-keep-base)
      ("u" smerge-keep-upper)
      ("l" smerge-keep-lower)
      ("a" smerge-keep-all)
      ("RET" smerge-keep-current)
      ("\C-m" smerge-keep-current)
      ("<" smerge-diff-base-upper)
      ("=" smerge-diff-upper-lower)
      (">" smerge-diff-base-lower)
      ("R" smerge-refine)
      ("E" smerge-ediff)
      ("C" smerge-combine-with-next)
      ("r" smerge-resolve)
      ("k" smerge-kill-current)
      ("ZZ" (lambda ()
              (interactive)
              (save-buffer)
              (bury-buffer))
       "Save and bury buffer" :color blue)
      ("q" nil "cancel" :color blue))

    (set-face-attribute 'smerge-refined-added nil
                        :background "#335533")
    (set-face-attribute 'smerge-lower nil
                        :background "#264026")
    (set-face-attribute 'smerge-refined-removed nil
                        :background "#553333")
    (set-face-attribute 'smerge-upper nil
                        :background "#402626"))
#+END_SRC
*** flycheck
Syntax checking

#+BEGIN_SRC emacs-lisp
  (use-package flycheck
    :straight t
    :diminish
    :defer 3
    :config
    (setq flycheck-idle-change-delay 1.0
          flycheck-buffer-switch-check-intermediate-buffers t
          flycheck-display-errors-delay 0.25)

    (setq-default flycheck-disabled-checkers
                  (append flycheck-disabled-checkers '(javascript-jshint json-jsonlint scss scss-lint ruby-reek))
                  flycheck-temp-prefix ".flycheck")

    ;; Set flycheck to only check when saving a file or changin a major mode
    ;; Done mainly for performance on windows
    (if IS-WINDOWS
        (setq flycheck-check-syntax-automatically '(save mode-enable)))

    (if (not (eq theme 'dark))
        (set-face-attribute 'flycheck-error-list-error nil :foreground "blue" ))

    ;; Use local eslint if available https://emacs.stackexchange.com/questions/21205/flycheck-with-file-relative-eslint-executable
    ;; (defun my/use-eslint-from-node-modules ()
    ;;   (let* ((root (locate-dominating-file
    ;;                 (or (buffer-file-name) default-directory)
    ;;                 "node_modules"))
    ;;          (eslint (and root
    ;;                       (expand-file-name "node_modules/eslint/bin/eslint.js"
    ;;                                         root))))
    ;;     (when (and eslint (file-executable-p eslint))
    ;;       (setq-local flycheck-javascript-eslint-executable eslint))))
    ;; (add-hook 'flycheck-mode-hook #'my/use-eslint-from-node-modules)

    (global-flycheck-mode))
#+END_SRC
*** UNIX_ONLY flyspell
Spell checking. Needs the aspell program installed.

#+BEGIN_SRC emacs-lisp
  (use-package flyspell
    :diminish
    :config
    (setq ispell-program-name "aspell"))
#+END_SRC
*** DISABLED ivy
#+BEGIN_SRC emacs-lisp
  (use-package ivy
    :straight t
    :demand t
    :diminish (ivy-mode . "")
    :config
    ;; Required to show the recent commands
    (use-package smex
      :straight t)

    (use-package wgrep
      :straight t)

    ;; sort results better
    (use-package flx
      :straight t)

    (use-package counsel
      :straight t)

    (use-package swiper
      :straight t)

    ;; configure regexp engine.
    (setq ivy-re-builders-alist
          '((counsel-projectile-find-file . ivy--regex-plus)
            (ivy-switch-buffer . ivy--regex-plus)
            (counsel-projectile-rg . ivy--regex-plus)
            (counsel-rg . ivy--regex-plus)
            (counsel-ag . ivy--regex-plus)
            (t   . ivy--regex-fuzzy)))

    ;; Set ivy for completion in projectile
    (setq projectile-completion-system 'ivy
          counsel-projectile-switch-project-action 'counsel-projectile-switch-project-action-find-file
          ivy-count-format "(%d/%d) "
          ivy-use-virtual-buffers t)

    (define-key global-map [remap list-buffers] 'ivy-switch-buffer)
    (define-key ivy-minibuffer-map [escape] 'minibuffer-keyboard-quit)
    (define-key ivy-minibuffer-map (kbd "<S-return>") 'ivy-immediate-done)
    (global-set-key (kbd "C-s") 'swiper)
    (global-set-key (kbd "M-x") 'counsel-M-x)
    (global-set-key (kbd "C-x C-f") 'counsel-find-file)

    (if (not (eq theme 'dark))
        (progn
          (set-face-attribute 'ivy-minibuffer-match-face-1 nil
                              :background "#F1C40F"
                              :foreground "white")
          (set-face-attribute 'ivy-minibuffer-match-face-2 nil
                              :background "#F1C40F"
                              :foreground "white")
          (set-face-attribute 'ivy-minibuffer-match-face-3 nil
                              :background "#F1C40F"
                              :foreground "white")
          (set-face-attribute 'ivy-minibuffer-match-face-4 nil
                              :background "#F1C40F"
                              :foreground "white")
          (set-face-attribute 'ivy-current-match nil
                              :background "#9B59B6"
                              :foreground "white")))

    (ivy-mode 1))
#+END_SRC
*** vertico-orderless-marginalia-consult
#+begin_src emacs-lisp
  ;; Enable vertico
  (use-package vertico
    :straight t
    :init
    (vertico-mode)

    (define-key vertico-map [escape] 'abort-minibuffers)
    (define-key vertico-map (kbd "<S-return>") 'vertico-exit-input)

    ;; Different scroll margin
    ;; (setq vertico-scroll-margin 0)

    ;; Show more candidates
    ;; (setq vertico-count 20)

    ;; Grow and shrink the Vertico minibuffer
    ;; (setq vertico-resize t)

    ;; Optionally enable cycling for `vertico-next' and `vertico-previous'.
    ;; (setq vertico-cycle t)

    (set-face-attribute 'vertico-current nil :background "#7550ed")

    ;; Configure directory extension.
    (use-package vertico-directory
      :straight nil
      :load-path "straight/build/vertico/extensions"
      :after vertico
      :ensure nil
      ;; More convenient directory navigation commands
      :bind (:map vertico-map
                  ("RET" . vertico-directory-enter)
                  ("DEL" . vertico-directory-delete-char)
                  ("M-DEL" . vertico-directory-delete-word))
      ;; Tidy shadowed file names
      :hook (rfn-eshadow-update-overlay . vertico-directory-tidy)))

  ;; A few more useful configurations...
  (use-package emacs
    :init
    ;; Add prompt indicator to `completing-read-multiple'.
    ;; We display [CRM<separator>], e.g., [CRM,] if the separator is a comma.
    (defun crm-indicator (args)
      (cons (format "[CRM%s] %s"
                    (replace-regexp-in-string
                     "\\`\\[.*?]\\*\\|\\[.*?]\\*\\'" ""
                     crm-separator)
                    (car args))
            (cdr args)))
    (advice-add #'completing-read-multiple :filter-args #'crm-indicator)

    ;; Do not allow the cursor in the minibuffer prompt
    (setq minibuffer-prompt-properties
          '(read-only t cursor-intangible t face minibuffer-prompt))
    (add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)

    ;; Emacs 28: Hide commands in M-x which do not work in the current mode.
    ;; Vertico commands are hidden in normal buffers.
    ;; (setq read-extended-command-predicate
    ;;       #'command-completion-default-include-p)

    ;; Enable recursive minibuffers
    (setq enable-recursive-minibuffers t))

  ;; Optionally use the `orderless' completion style.
  (use-package orderless
    :straight t
    :init
    ;; Configure a custom style dispatcher (see the Consult wiki)
    ;; (setq orderless-style-dispatchers '(+orderless-consult-dispatch orderless-affix-dispatch)
    ;;       orderless-component-separator #'orderless-escapable-split-on-space)
    (setq completion-styles '(orderless basic)
          completion-category-defaults nil
          completion-category-overrides '((file (styles partial-completion)))))

  ;; Enable rich annotations using the Marginalia package
  (use-package marginalia
    :straight t
    ;; Either bind `marginalia-cycle' globally or only in the minibuffer
    :bind (("M-A" . marginalia-cycle)
           :map minibuffer-local-map
           ("M-A" . marginalia-cycle))

    ;; The :init configuration is always executed (Not lazy!)
    :init

    ;; Must be in the :init section of use-package such that the mode gets
    ;; enabled right away. Note that this forces loading the package.
    (marginalia-mode))

  ;; Example configuration for Consult
  (use-package consult
    :straight t
    ;; Enable automatic preview at point in the *Completions* buffer. This is
    ;; relevant when you use the default completion UI.
    :hook (completion-list-mode . consult-preview-at-point-mode)

    ;; The :init configuration is always executed (Not lazy)
    :init

    ;; Optionally configure the register formatting. This improves the register
    ;; preview for `consult-register', `consult-register-load',
    ;; `consult-register-store' and the Emacs built-ins.
    (setq register-preview-delay 0.5
          register-preview-function #'consult-register-format)

    ;; Optionally tweak the register preview window.
    ;; This adds thin lines, sorting and hides the mode line of the window.
    (advice-add #'register-preview :override #'consult-register-window)

    ;; Use Consult to select xref locations with preview
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref)

    ;; Configure other variables and modes in the :config section,
    ;; after lazily loading the package.
    :config
    ;; Optionally configure preview. The default value
    ;; is 'any, such that any key triggers the preview.
    ;; (setq consult-preview-key 'any)
    ;; (setq consult-preview-key "M-.")
    ;; (setq consult-preview-key '("S-<down>" "S-<up>"))
    ;; For some commands and buffer sources it is useful to configure the
    ;; :preview-key on a per-command basis using the `consult-customize' macro.
    (consult-customize
     consult-theme :preview-key '(:debounce 0.2 any)
     consult-ripgrep consult-git-grep consult-grep
     consult-bookmark consult-recent-file consult-xref
     consult--source-bookmark consult--source-file-register
     consult--source-recent-file consult--source-project-recent-file
     ;; :preview-key "M-."
     :preview-key '(:debounce 0.4 any))

    ;; Optionally configure the narrowing key.
    ;; Both < and C-+ work reasonably well.
    (setq consult-narrow-key "<") ;; "C-+"

    ;; Optionally make narrowing help available in the minibuffer.
    ;; You may want to use `embark-prefix-help-command' or which-key instead.
    ;; (define-key consult-narrow-map (vconcat consult-narrow-key "?") #'consult-narrow-help)

    ;; By default `consult-project-function' uses `project-root' from project.el.
    ;; Optionally configure a different project root function.
    ;;;; 1. project.el (the default)
    ;; (setq consult-project-function #'consult--default-project--function)
    ;;;; 2. vc.el (vc-root-dir)
    ;; (setq consult-project-function (lambda (_) (vc-root-dir)))
    ;;;; 3. locate-dominating-file
    ;; (setq consult-project-function (lambda (_) (locate-dominating-file "." ".git")))
    ;;;; 4. projectile.el (projectile-project-root)
    ;; (autoload 'projectile-project-root "projectile")
    ;; (setq consult-project-function (lambda (_) (projectile-project-root)))
    ;;;; 5. No project support
    ;; (setq consult-project-function nil)
    )

  (use-package consult-projectile
    :straight t
    :demand t)
#+end_src
*** wgrep
#+begin_src emacs-lisp
  (use-package wgrep
    :straight t)
#+end_src
*** projectile
#+BEGIN_SRC emacs-lisp
  (use-package projectile
    :straight t
    :diminish " P"
    :commands (projectile-switch-project)
    :config
    (setq projectile-mode-line (format " [%s]" (projectile-project-name))
          projectile-globally-ignored-directories (append projectile-globally-ignored-directories '(".stversions" "vendor")))

    (if IS-WINDOWS
        (setq projectile-indexing-method 'alien))

    (projectile-global-mode))
#+END_SRC
*** company
Autocompletion

#+BEGIN_SRC emacs-lisp
  (use-package company
    :straight t
    :defer 2
    :hook
    (after-init . global-company-mode)
    :config
    ;; Disable autocompletion in org files
    (setq company-global-modes '(not org-mode)
          company-idle-delay 1.5 ;; default is 0.2
          company-minimum-prefix-length 2)
    :bind
    (("C-;" . company-complete)))
#+END_SRC
*** lsp-mode
#+begin_src emacs-lisp
  (use-package lsp-mode
    :straight t
    :hook (ruby-mode . lsp)
    :hook (js-mode . lsp)
    :hook (typescript-mode . lsp)
    :hook (go-mode . lsp)
    :commands (lsp lsp-deferred)
    :config
    (setq lsp-prefer-flymake nil
          lsp-headerline-breadcrumb-enable nil
          lsp-modeline-diagnostics-enable t
          lsp-idle-delay 1.000 ; performance
          lsp-log-io nil  ; if set to true can cause a performance hit
          lsp-eslint-run "onSave"
          lsp-yaml-schemas '((Kubernetes . ["/k8s/**/*.yml"])))

    (use-package lsp-ui
      :straight t
      :commands lsp-ui-mode
      :config
      (setq lsp-ui-doc-enable nil
            lsp-ui-imenu-enable nil
            lsp-ui-peek-enable nil
            lsp-ui-sideline-enable nil
            lsp-line-ignore-duplicate t))

    (use-package lsp-treemacs
      :straight t
      :defer t
      :after treemacs lsp
      :commands (lsp-treemacs-errors-list lsp-treemacs-references)
      :config
      (defun hbournis/lsp-treemacs-references ()
        (interactive)
        (hbournis/call-with-prefix 'lsp-treemacs-references))))
#+end_src
*** DISABLED dap-mode
debugger

Not working currently

#+begin_src emacs-lisp
  (use-package dap-mode
    :straight t
    ;; Uncomment the config below if you want all UI panes to be hidden by default!
    ;; :custom
    ;; (lsp-enable-dap-auto-configure nil)
    ;; :config
    ;; (dap-ui-mode 1)
    :commands dap-debug
    :config
    ;; Set up Node debugging
    (require 'dap-node)
    (dap-node-setup) ;; Automatically installs Node debug adapter if needed
    (dap-go-setup)
    (require 'dap-hydra)
    (require 'dap-gdb-lldb)
    (dap-gdb-lldb-setup)
    )
#+end_src
*** editorconfig
#+BEGIN_SRC emacs-lisp
  (use-package editorconfig
    :straight t
    :diminish
    :config
    (editorconfig-mode 1))
#+END_SRC
*** smartparens
#+BEGIN_SRC emacs-lisp
  (use-package smartparens
    :straight t
    :defer 2
    :diminish
    :config
    (require 'smartparens-config)
    (add-hook 'emacs-lisp-mode-hook 'smartparens-strict-mode)
    (add-hook 'typescript-mode-hook 'smartparens-mode)
    (add-hook 'web-mode-hook 'smartparens-mode)
    (add-hook 'js-mode-hook 'smartparens-strict-mode)
    ;; (add-hook 'html-mode-hook 'smartparens-strict-mode)
    (add-hook 'ruby-mode-hook 'smartparens-strict-mode)
    (add-hook 'python-mode-hook 'smartparens-strict-mode)
    (add-hook 'sh-mode-hook 'smartparens-strict-mode)
    (add-hook 'clojure-mode-hook 'smartparens-strict-mode)
    (add-hook 'clojurescript-mode-hook 'smartparens-strict-mode)
    (add-hook 'go-mode-hook 'smartparens-strict-mode)
    (add-hook 'svelte-mode-hook 'smartparens-mode)

    (show-smartparens-global-mode t)

    (use-package evil-smartparens
      :straight t
      :diminish
      :config
      (add-hook 'smartparens-enabled-hook #'evil-smartparens-mode)))
#+END_SRC
*** windmove

#+BEGIN_SRC emacs-lisp
  (use-package windmove
    :straight t
    :commands (windmove-up windmove-down windmove-left windmove-right))
#+END_SRC

*** DISABLED desktop
Save emacs session

#+BEGIN_SRC emacs-lisp
  (use-package desktop
    :straight t
    :commands (projectile-switch-project)
    :config
    (setq desktop-path '("~/.emacs.d/etc/")
          desktop-dirname "~/.emacs.d/etc/"
          desktop-base-file-name "emacs-desktop"
          desktop-globals-to-save
          (append '((extended-command-history . 50)
                    (file-name-history . 400)
                    (grep-history . 50)
                    (compile-history . 50)
                    (minibuffer-history . 100)
                    (query-replace-history . 100)
                    (read-expression-history . 100)
                    (regexp-history . 100)
                    (regexp-search-ring . 100)
                    (search-ring . 50)
                    (shell-command-history . 50)
                    tags-file-name
                    register-alist)))
    (desktop-save-mode t))
#+END_SRC
*** tab-bar-mode
#+begin_src emacs-lisp
  (setq tab-bar-new-button-show nil
        tab-bar-show nil
        tab-bar-format '(tab-bar-format-tabs)
        tab-bar-close-button-show nil)

  (defun hbournis/tab-exists-p (name)
    (member name (mapcar (lambda (tab) (alist-get 'name tab)) (tab-bar-tabs))))

  (tab-bar-mode)
  (tab-bar-rename-tab "1")

  (mapcar (lambda (tab-name)
          (unless (hbournis/tab-exists-p tab-name)
            (progn
              (tab-bar-new-tab)
              (tab-bar-rename-tab tab-name))))
        '("2" "3"))

  ;; (tab-bar-new-tab)
  ;; (tab-bar-rename-tab "3")
  (tab-bar-switch-to-tab "1")

  (if (eq theme 'dark)
      (progn
        (set-face-attribute 'tab-bar-tab-inactive nil
                            :box nil
                            :foreground "#BDC3C7"
                            :background 'unspecified
                            :inherit 'bold)
        (set-face-attribute 'tab-bar-tab nil
                            :box nil
                            :foreground "#00d3d0"
                            :background 'unspecified)

        )
    (progn
      (set-face-attribute 'tab-bar-tab nil
                          :box nil
                          :foreground "#16A085"
                          :background 'unspecified)
      (set-face-attribute 'tab-bar-tab-inactive nil
                          :box nil
                          :foreground "#BDC3C7"
                          :background 'unspecified)
      ))

  (global-set-key   (kbd "C-1")  (lambda () (interactive) (hbournis/switch-to-or-create-tab "1")))
  (global-set-key   (kbd "C-2")  (lambda () (interactive) (hbournis/switch-to-or-create-tab "2")))
  (global-set-key   (kbd "C-3")  (lambda () (interactive) (hbournis/switch-to-or-create-tab "3")))
#+end_src
*** git-gutter
#+BEGIN_SRC emacs-lisp
  (use-package git-gutter
    :straight t
    :defer 3
    :diminish
    :config
    (setq git-gutter:update-interval 2
          git-gutter:hide-gutter t)

    (set-face-attribute 'git-gutter:added nil
                             :background "#000000"
                             :foreground "#338533")
    (set-face-attribute 'git-gutter:modified nil
                             :background "#000000"
                             :foreground "#8B7233")
    (set-face-attribute 'git-gutter:deleted nil
                             :background "#000000"
                             :foreground "#A54B6F")
    (set-face-attribute 'git-gutter:separator nil
                             :background "#000000"
                             :foreground "#3372A5")

    (global-git-gutter-mode t))
#+END_SRC
*** DISABLED gitignore-templates
An Emacs Package for GitHub .gitignore templates

#+BEGIN_SRC emacs-lisp
  (use-package gitignore-templates
    :straight t)
#+END_SRC
*** ag

#+BEGIN_SRC emacs-lisp
  (use-package ag
    :straight t
    :config
    (setq ag-highlight-search t
          ag-reuse-window t))
#+END_SRC
*** which-key
Display the keys available after pressing C-x for example.

#+BEGIN_SRC emacs-lisp
  (use-package which-key
    :straight t
    :diminish
    :config
    ;;(setq which-key-idle-delay 0.2)
    ;;(which-key-setup-side-window-right-bottom)
    (which-key-mode))
#+END_SRC
*** dtrt-indent
guesses the correct indentation

#+BEGIN_SRC emacs-lisp
  (use-package dtrt-indent
    :straight t
    :hook (diminish 'dtrt-indent-mode)
    :config
    (dtrt-indent-mode t))
#+END_SRC
*** rainbow-mode
shows the color of hex color codes as their background

#+BEGIN_SRC emacs-lisp
  (use-package rainbow-mode
    :straight t
    :diminish
    :config
    ;; enable it by default in org mode
    ;; (defun rainbow-mode-hook ()
      ;; (rainbow-mode t))
    ;; (add-hook 'org-mode-hook 'rainbow-mode-hook)
    )
#+END_SRC
*** diminish
hide specific modes from the modeline

#+begIN_SRC emacs-lisp
  (use-package diminish
    :straight t
    :config
    (eval-after-load 'org-indent '(diminish 'org-indent-mode))

    (diminish 'auto-fill-function)
    (diminish 'auto-revert-mode)
    (diminish 'eldoc-mode))
#+END_SRC
*** exec-path-from-shell
Get environment variables from the shell

#+BEGIN_SRC emacs-lisp
  (use-package exec-path-from-shell
    :straight t
    :defer 2
    :if (memq window-system '(mac ns x))
    :config
    (exec-path-from-shell-initialize))
#+END_SRC
*** DISABLED calfw
Calendar framework

#+BEGIN_SRC emacs-lisp
  (use-package calfw
    :straight t
    :init
    (use-package calfw-org
      :straight t)

    :config
    (require 'calfw-org))
#+END_SRC
*** ranger
Emulates ranger in emacs. Replaces dired when browsing folders.

#+BEGIN_SRC emacs-lisp
  (use-package ranger
    :straight t
    :defer 1
    :config
    (setq ranger-override-dired 'ranger
          ranger-show-hidden t
          ranger-modify-header t
          ranger-preview-file nil
          ranger-show-literal t
          ranger-max-preview-size 10
          ranger-dont-show-binary t
          ranger-cleanup-on-disable t
          ranger-excluded-extensions '("mkv" "iso" "mp4" "mp3" "avi" "log"))
    (ranger-override-dired-mode t)
    ;; Remap C-h to its normal functionality
    (define-key ranger-mode-map "\C-h k" 'describe-key)
    ;; Create directory with "cd" like in Treemacs
    (define-key ranger-mode-map "cd" (lambda () (interactive) (progn (call-interactively #'dired-create-directory) (ranger-refresh))))
    ;; Create file with "cf" like in Treemacs
    (define-key ranger-mode-map "cf" (lambda () (interactive) (progn (call-interactively #'hbournis/dired-create-file) (ranger-refresh))))

    (set-face-attribute 'hl-line nil :background "#7550ed"))
#+END_SRC
*** DISABLED pdf-tools
Disabled for now because it requires extra packages to be installed in the
system in order to work.
#+BEGIN_SRC emacs-lisp
    (use-package pdf-tools
      :straight t
      :config
      (pdf-tools-install))
#+END_SRC
*** git-timemachine
#+BEGIN_SRC emacs-lisp
  (use-package git-timemachine
    :straight t
    :config
    (evil-define-minor-mode-key 'normal 'git-timemachine-mode
      (kbd "<return>")  'git-timemachine-show-commit))
#+END_SRC
*** treemacs
#+BEGIN_SRC emacs-lisp
  (use-package treemacs
    :straight t
    :init
    (with-eval-after-load 'winum
      (define-key winum-keymap (kbd "M-0") #'treemacs-select-window))
    :bind (:map global-map ([f8] . treemacs))
    :config
    (setq treemacs-collapse-dirs              (if (executable-find "python") 3 0)
          treemacs-python-executable          "python3"
          treemacs-file-event-delay           5000
          treemacs-follow-after-init          t
          treemacs-follow-recenter-distance   0.1
          treemacs-goto-tag-strategy          'refetch-index
          treemacs-indentation                2
          treemacs-indentation-string         " "
          treemacs-is-never-other-window      nil
          treemacs-no-png-images              nil
          treemacs-project-follow-cleanup     nil
          treemacs-recenter-after-file-follow nil
          treemacs-recenter-after-tag-follow  nil
          treemacs-show-hidden-files          t
          treemacs-silent-filewatch           nil
          treemacs-silent-refresh             nil
          treemacs-sorting                    'alphabetic-case-insensitive-asc
          treemacs-tag-follow-cleanup         t
          treemacs-tag-follow-delay           1.5
          treemacs-width                      35)

    (treemacs-follow-mode t)
    (treemacs-filewatch-mode t)
    (pcase (cons (not (null (executable-find "git")))
                 (not (null (executable-find "python3"))))
      (`(t . t)
       (treemacs-git-mode 'extended))
      (`(t . _)
       (treemacs-git-mode 'simple)))

    (use-package treemacs-evil
      :after treemacs evil
      :straight t)

    (use-package treemacs-projectile
      :after treemacs projectile
      :straight t))
#+END_SRC
*** dumb-jumb
#+begin_src emacs-lisp
  (use-package dumb-jump
    :straight t
    :config
    (setq dumb-jump-selector 'ivy))
#+end_src
*** hydra
#+BEGIN_SRC emacs-lisp
  (use-package hydra
    :straight t
    :config
    (require 'hydra-examples)

    (defhydra zoom (global-map "<f2>")
      "zoom"
      ("j" hbournis/increment-font-size "in")
      ("k" hbournis/decrement-font-size  "out"))

    (defhydra hydra-global-org (:color blue)
      "Org"
      ("t" org-timer-start "Start Timer")
      ("s" org-timer-stop "Stop Timer")
      ("r" org-timer-set-timer "Set Timer") ; This one requires you be in an orgmode doc, as it sets the timer for the header
      ("p" org-timer "Print Timer") ; output timer value to buffer
      ("w" (org-clock-in '(4)) "Clock-In") ; used with (org-clock-persistence-insinuate) (setq org-clock-persist t)
      ("o" org-clock-out "Clock-Out") ; you might also want (setq org-log-note-clock-out t)
      ("j" org-clock-goto "Clock Goto") ; global visit the clocked task
      ("c" org-capture "Capture") ; Don't forget to define the captures you want http://orgmode.org/manual/Capture.html
      ("l" org-capture-goto-last-stored "Last Capture"))

    (defhydra hydra-window-deluxe-custom (global-map "<f3>")
      "
  Move^^  ^Resize^ ^Split^          ^Switch^
  --------------------------------------------
  _h_ ←   _H_ X←   _v_ertical       _b_uffer
  _j_ ↓   _J_ X↓   _x_ horizontal   _f_ind
  _k_ ↑   _K_ X↑   _z_ undo         _d_elete
  _l_ →   _L_ X→   _Z_ redo
  "
      ("h" windmove-left )
      ("j" windmove-down )
      ("k" windmove-up )
      ("l" windmove-right )
      ("H" hydra-move-splitter-left)
      ("J" hydra-move-splitter-down)
      ("K" hydra-move-splitter-up)
      ("L" hydra-move-splitter-right)
      ("b" helm-mini)
      ("f" helm-find-files)
      ("v" (lambda ()
             (interactive)
             (split-window-right)
             (windmove-right))
       )
      ("x" (lambda ()
             (interactive)
             (split-window-below)
             (windmove-down))
       )
      ("d" delete-window)
      ("z" (progn
             (winner-undo)
             (setq this-command 'winner-undo))
       )
      ("Z" winner-redo)
      )
    (global-set-key (kbd "M-#") 'hydra-windows/body))
#+END_SRC
*** Docker
**** DISABLED docker
#+BEGIN_SRC emacs-lisp
  (use-package docker
    :straight t
    :config
    (setenv "DOCKER_TLS_VERIFY" "1")
    (setenv "DOCKER_HOST" "tcp://10.11.12.13:2376")
    (setenv "DOCKER_CERT_PATH" "/Users/foo/.docker/machine/machines/box")
    (setenv "DOCKER_MACHINE_NAME" "box"))
#+END_SRC
**** NOT_WINDOWS dockerfile-mode
#+BEGIN_SRC emacs-lisp
  (use-package dockerfile-mode
    :straight t
    :config
    (add-to-list 'auto-mode-alist '("Dockerfile\\'" . dockerfile-mode)))
#+END_SRC
**** NOT_WINDOWS docker-compose-mode
#+BEGIN_SRC emacs-lisp
  (use-package docker-compose-mode
    :straight t)
#+END_SRC
*** restclient.el
#+BEGIN_SRC emacs-lisp
  (use-package restclient
    :straight t
    :mode (("\\.rest\\'" . restclient-mode))
    :config
    ;; show response in fundamental mode only to speed it up
    (setq restclient-response-size-threshold 0.00001))
#+END_SRC
*** WORK_ONLY eredis
Redis client
#+begin_src emacs-lisp
  (use-package eredis
    :straight t
    :defer t)
#+end_src
*** yasnippet
[[https://github.com/AndreaCrotti/yasnippet-snippets][Snippets]]

#+BEGIN_SRC emacs-lisp
  (use-package yasnippet
    :straight t
    :diminish yas-minor-mode
    :config
    (use-package yasnippet-snippets
      :straight t)

    (yas-global-mode 1))
#+END_SRC
*** whiteroom-mode
https://github.com/joostkremers/writeroom-mode

#+begin_src emacs-lisp
  (use-package writeroom-mode
    :straight t)
#+end_src
*** DISABLED nswbuff
Go to next/previous buffer in a project-aware context

#+begin_src emacs-lisp
  (use-package nswbuff
    :straight t
    :config
    (setq nswbuff-buffer-list-function #'nswbuff-projectile-buffer-list
          nswbuff-clear-delay 0
          nswbuff-exclude-buffer-regexps '("^ .*" "^\\*.*\\*")))

#+end_src
*** aggressive-indent
#+begin_src emacs-lisp
  (use-package aggressive-indent
    :straight t
    :defer 4
    :config
    (setq aggressive-indent-sit-for-time 0.2)
    (global-aggressive-indent-mode t)
    (add-to-list 'aggressive-indent-excluded-modes '(elisp-mode web-mode typescript-mode sql-mode)))
#+end_src
*** csv-mode
#+begin_src emacs-lisp
  (use-package csv-mode
    :straight t)
#+end_src
*** deadgrep
#+begin_src emacs-lisp
  (use-package deadgrep
    :straight t
    :bind (("<f5>" . deadgrep)))
#+end_src
*** DISABLED itail
see logs easily

#+begin_src emacs-lisp
  (use-package itail
    :straight t)
#+end_src
*** NOT_WORK hledger
#+begin_src emacs-lisp
  (use-package hledger-mode
    :straight t
    :mode
    (("\\.hledger\\'" . hledger-mode))
    :config
    ;; Provide the path to you journal file.
    ;; The default location is too opinionated.
    ;; (setq hledger-jfile "/Users/....hledger.journal")

    (add-to-list 'company-backends 'hledger-company))
#+end_src

** Programming Language Specific
*** HTML/CSS
**** DISABLED emmet-mode
Use C-j to expand.

#+BEGIN_SRC emacs-lisp
  (use-package emmet-mode
    :straight t
    :config
    ;; Autostart on any markup modes and CSS
    (define-key emmet-mode-keymap [tab] 'emmet-expand-line)
    (add-hook 'sgml-mode-hook 'emmet-mode)
    (add-hook 'web-mode-hook 'emmet-mode)
    (add-hook 'css-mode-hook 'emmet-mode))
#+END_SRC
**** web-mode
#+BEGIN_SRC emacs-lisp
  (use-package web-mode
    :straight t
    :mode
    (("\\.html?\\'" . web-mode)
     ("\\.tsx\\'" . web-mode)
     ("\\.vue\\'" . web-mode)
     ("\\.jsx\\'" . web-mode)
     ("\\.phtml\\'" . web-mode)
     ("\\.tpl\\.php\\'" . web-mode)
     ("\\.[agj]sp\\'" . web-mode)
     ("\\.as[cp]x\\'" . web-mode)
     ("\\.erb\\'" . web-mode)
     ("\\.mustache\\'" . web-mode)
     ("\\.djhtml\\'" . web-mode))
    :hook
    (web-mode . display-line-numbers-mode)
    (html-mode . display-line-numbers-mode)
    :config
    (setq web-mode-enable-css-colorization t
          web-mode-enable-auto-pairing t
          web-mode-enable-comment-keywords t
          web-mode-enable-current-element-highlight t
          web-mode-enable-auto-indentation nil

          web-mode-markup-indent-offset 2
          web-mode-css-indent-offset 2
          web-mode-code-indent-offset 2
          web-mode-block-padding 2
          web-mode-comment-style 2)

    (set-face-attribute 'web-mode-function-name-face nil
                        :foreground "#de935f")

    (flycheck-add-mode 'javascript-eslint 'web-mode))
#+END_SRC

**** DISABLED Improving the JSX syntax-hightlighting in web-mode
I don't even remember what this is

#+BEGIN_SRC emacs-lisp
;; for better jsx syntax-highlighting in web-mode
;; - courtesy of Patrick @halbtuerke
(defadvice web-mode-highlight-part (around tweak-jsx activate)
  (if (equal web-mode-content-type "jsx")
    (let ((web-mode-enable-part-face nil))
      ad-do-it)
    ad-do-it))
#+END_SRC
**** DISABLED haml-mode
#+begin_src emacs-lisp
  (use-package haml-mode
    :straight t
    :hook
    (haml-mode . display-line-numbers-mode)
    :config
    (add-to-list 'auto-mode-alist '("\\.hamlc\\'" . haml-mode)))
#+end_src
*** JavaScript
Some guides:
- https://patrickskiba.com/emacs/2019/09/07/emacs-for-react-dev.html
- https://emacs.cafe/emacs/javascript/setup/2017/04/23/emacs-setup-javascript.html

**** js-mode
#+begin_src emacs-lisp
  (setq js-indent-level 2)
  (add-hook 'js-mode-hook 'display-line-numbers-mode)
#+end_src

**** json-mode
#+BEGIN_SRC emacs-lisp
  (use-package json-mode
    :straight t)
#+END_SRC
**** typescript-mode
#+BEGIN_SRC emacs-lisp
  (use-package typescript-mode
    :straight t
    :hook
    (typescript-mode . display-line-numbers-mode)
    :config
    (setq typescript-indent-level 2))
#+END_SRC
**** jest-test-mode
#+begin_src emacs-lisp
  (use-package jest-test-mode
    :ensure t
    :defer t
    :commands jest-test-mode
    :hook (typescript-mode)
    :config
    (setq jest-test-command-string "pnpm %s exec jest %s --verbose --detectOpenHandles %s"))
#+end_src
**** DISABLED mocha
Customized for jest [[https://github.com/scottaj/mocha.el/issues/3#issuecomment-318919735][Source]]

#+BEGIN_SRC emacs-lisp
  (use-package mocha
    :straight t
    :commands (mocha-test-project
               mocha-debug-project
               mocha-test-file
               mocha-debug-file
               mocha-test-at-point
               mocha-debug-at-point)
    :config
    ;; Clear up stray ansi escape sequences.
    (defvar jj*--mocha-ansi-escape-sequences
      ;; https://emacs.stackexchange.com/questions/18457/stripping-stray-ansi-escape-sequences-from-eshell
      (rx (or
           "^[\\[[0-9]+[a-z]"
           "�[1A"
           "�[999D")))

    (defun jj*--mocha-compilation-filter ()
      "Filter function for compilation output."
      (ansi-color-apply-on-region compilation-filter-start (point-max))
      (save-excursion
        (goto-char compilation-filter-start)
        (while (re-search-forward jj*--mocha-ansi-escape-sequences nil t)
          (replace-match ""))))

    (advice-add 'mocha-compilation-filter :override 'jj*--mocha-compilation-filter)

    ;; https://github.com/scottaj/mocha.el/issues/3
    (defcustom mocha-jest-command "node_modules/jest/bin/jest.js --colors"
      "The path to the jest command to run."
      :type 'string
      :group 'mocha)

    (defun mocha-generate-command--jest-command (debug &optional filename testname)
      "Generate a command to run the test suite with jest.
  If DEBUG is true, then make this a debug command.
  If FILENAME is specified run just that file otherwise run
  MOCHA-PROJECT-TEST-DIRECTORY.
  IF TESTNAME is specified run jest with a pattern for just that test."
      (let ((target (if testname (concat " --testNamePattern \"" testname "\"") ""))
            (path (if (or filename mocha-project-test-directory)
                      (concat " --testPathPattern \""
                              (if filename filename mocha-project-test-directory)
                              "\"" " --config=\"jest.config.ts\"")
                    ""))
            (node-command
             (concat mocha-which-node
                     (if debug (concat " --debug=" mocha-debug-port) ""))))
        (concat node-command " "
                mocha-jest-command
                target
                path)))

    (advice-add 'mocha-generate-command
                :override 'mocha-generate-command--jest-command))
#+END_SRC
**** DISABLED svelte
#+begin_src emacs-lisp
  (use-package svelte-mode
    :straight t
    :hook (svelte-mode . lsp-deferred)
    :mode (("\\.svelte\\'" . svelte-mode)))
#+end_src
*** PureScript
**** DISABLED purescript-mode
#+BEGIN_SRC emacs-lisp
  (use-package purescript-mode
    :straight t
    :hook (purescript-mode . display-line-numbers-mode))
#+END_SRC
**** DISABLED psc-ide
#+BEGIN_SRC emacs-lisp
  (use-package psc-ide
    :straight t
    :config
    (add-hook 'purescript-mode-hook
              (lambda ()
                (psc-ide-mode)
                (company-mode)
                (flycheck-mode)
                (turn-on-purescript-indentation))))
#+END_SRC
*** Java
**** NOT_WINDOWS java-mode (CC mode)
#+BEGIN_SRC emacs-lisp
  ;; Set indentation to 4 for java
  (setq-default c-basic-offset 4)
#+END_SRC
*** Markdown
**** markdown-mode
#+BEGIN_SRC emacs-lisp
  (use-package markdown-mode
    :straight t
    :commands (markdown-mode gfm-mode)
    :hook (markdown-mode . flyspell-mode)
    :mode (("README\\.md\\'" . gfm-mode)
           ("\\.md\\'" . markdown-mode)
           ("\\.markdown\\'" . markdown-mode))
    :init (setq markdown-command "multimarkdown"))
#+END_SRC
*** YAML
**** yaml-mode
#+BEGIN_SRC emacs-lisp
  (use-package yaml-mode
    :straight t
    :mode
    (("\\.yml?\\'" . yaml-mode)
     ("\\.yaml\\'" . yaml-mode))
    :hook
    (yaml-mode . display-line-numbers-mode)
    :config
    ;;  Unlike python-mode, this mode follows the Emacs convention of not
    ;; binding the ENTER key to `newline-and-indent'.  To get this
    ;; behavior, add the key definition to `yaml-mode-hook':
    (add-hook 'yaml-mode-hook
              #'(lambda ()
                  (define-key yaml-mode-map "\C-m" 'newline-and-indent))))
#+END_SRC
*** Ruby
**** ruby-mode
#+BEGIN_SRC emacs-lisp
  (use-package ruby-mode
    :straight t
    :mode
    (("\\.rbi?\\'" . ruby-mode))
    :config
    (add-hook 'ruby-mode-hook 'display-line-numbers-mode)
    (setq ruby-insert-encoding-magic-comment nil))
#+END_SRC
**** MAC_ONLY inf-ruby
#+BEGIN_SRC emacs-lisp
  (use-package inf-ruby
    :straight t
    :config
    (setq inf-ruby-console-environment "development")
    (add-hook 'after-init-hook 'inf-ruby-switch-setup))
#+END_SRC
**** MAC_ONLY projectile-rails
#+BEGIN_SRC emacs-lisp
  (use-package projectile-rails
    :straight t
    :after projectile
    :diminish
    :config
    (projectile-rails-global-mode))
#+END_SRC
**** MAC_ONLY rspec-mode
Enhancements to ruby-mode for RSpec files.

#+BEGIN_SRC emacs-lisp
  (use-package rspec-mode
    :straight t
    :general (:keymaps 'rspec-compilation-mode-map "r" 'rspec-rerun)
    :config
    (setq compilation-scroll-output t
          rspec-use-spring-when-possible nil
          rspec-allow-multiple-compilation-buffers t
          rspec-spec-command "rspec --fail-fast")

    (eval-after-load 'rspec-mode '(rspec-install-snippets)))
#+END_SRC
**** MAC_ONLY minitest-mode
#+BEGIN_SRC emacs-lisp
  (use-package minitest
    :straight t
    :hook (ruby-mode . minitest-mode)
    :config
    (setq minitest-use-rails t))
#+END_SRC
**** MAC_ONLY bundler
Interact with bundler with Emacs

#+BEGIN_SRC emacs-lisp
  (use-package bundler
    :straight t)
#+END_SRC
**** MAC_ONLY rubocop
#+BEGIN_SRC emacs-lisp
  (use-package rubocop
    :straight t
    :config
    ;; Load rubocopfmt
    (add-to-list 'load-path "~/.emacs.d/lisp/rubocopfmt.el")
    (require 'rubocopfmt)
    ;; (add-hook 'ruby-mode-hook #'rubocopfmt-mode)
    (diminish 'rubocopfmt-mode)
    ;; Use Gemfile's Rubocop if it exists, otherwise use global
    (setq rubocopfmt-use-bundler-when-possible nil))
#+END_SRC
*** Haskell
**** DISABLED intero
[[https://github.com/chrisdone/intero][Deprecated]]
replace with: https://github.com/jyp/dante

#+BEGIN_SRC emacs-lisp
  (use-package intero
    :straight t
    :config
    (add-hook 'haskell-mode-hook 'intero-mode))
#+END_SRC
*** R & Julia
**** DISABLED ESS (Emacs Spearks Statistics)
[[http://ess.r-project.org/][ESS]] provides modes for R and Julia. When I tried to install it from master it
was broken, so melpa-stable should be preferred.

#+BEGIN_SRC emacs-lisp
    (use-package ess
      :straight t)
#+END_SRC
*** Prolog
**** DISABLED Prolog-mode
#+BEGIN_SRC emacs-lisp
(setq prolog-system 'swi)
(autoload 'prolog-mode "prolog" "Major mode for editing Prolog programs." t)
(add-to-list 'auto-mode-alist '("\\.pl\\'" . prolog-mode))
#+END_SRC
**** DISABLED Ediprolog
"[[https://github.com/triska/ediprolog][ediprolog]] lets you interact with SWI-Prolog in all Emacs buffers. You can
consult Prolog programs and evaluate embedded queries."

#+BEGIN_SRC emacs-lisp
  (use-package ediprolog
    :straight t
    :config
    (global-set-key [f10] 'ediprolog-dwim))
#+END_SRC
**** DISABLED ob-prolog
Org-babel support for prolog.

#+BEGIN_SRC emacs-lisp
  (use-package ob-prolog
    :straight t)
#+END_SRC
*** Clojure/ClojureScript
**** DISABLED clojure-mode
#+BEGIN_SRC emacs-lisp
  (use-package clojure-mode
    :straight t
    :hook
    (clojure-mode . display-line-numbers-mode)
    :config
    ;; (require 'flycheck-clj-kondo)

    ;; Start cider in test env in order to run tests
    ;; Source: https://stackoverflow.com/questions/18304271/how-do-i-choose-switch-leiningen-profiles-with-emacs-nrepl
    (defun cider-jack-in-test-env ()
      (interactive)
      (let ((lein-params "with-profile +test repl :headless"))
        (message "lein-params set to: %s" lein-params)
        (set-variable 'cider-lein-parameters lein-params)
        (cider-jack-in '()))))

#+END_SRC
**** DISABLED cider
CIDER extends Emacs with support for interactive programming in Clojure.

#+begin_src emacs-lisp
  (use-package cider
    :straight t
    :config
    (setq cider-repl-history-file "~/.emacs.d/cider-history"))
#+end_src
**** DISABLED flycheck-clojure
#+begin_src emacs-lisp
  (use-package flycheck-clojure
    :straight t
    :config
    (use-package flycheck-pos-tip
      :straight t
      :config
      (with-eval-after-load 'flycheck
        (flycheck-pos-tip-mode)))
    (use-package flycheck-clj-kondo
      :straight t)
    (eval-after-load 'flycheck '(flycheck-clojure-setup))
    (eval-after-load 'flycheck
      '(setq flycheck-display-errors-function #'flycheck-pos-tip-error-messages))
    (eval-after-load 'flycheck
      (dolist (checker '(clj-kondo-clj clj-kondo-cljs clj-kondo-cljc clj-kondo-edn))
        (setq flycheck-checkers (cons checker (delq checker flycheck-checkers))))))
#+end_src
**** DISABLED ob-clojurescript
#+BEGIN_SRC emacs-lisp
  (use-package ob-clojurescript
    :straight t)
#+END_SRC
*** Latex
**** NOT_WORK Auctex
#+BEGIN_SRC emacs-lisp
  (use-package tex
  :straight auctex
  :defer t)
#+END_SRC
**** DISABLED latex-preview-pane
#+BEGIN_SRC emacs-lisp
  (use-package latex-preview-pane
    :straight t
    :config
    (latex-preview-pane-enable))
#+END_SRC
*** go
**** DISABLED go mode
#+begin_src emacs-lisp
  (use-package go-mode
    :straight t
    :hook
    (go-mode . display-line-numbers-mode)
    :config
    (add-hook 'go-mode-hook
              (lambda ()
                (add-hook 'before-save-hook
                          #'gofmt-before-save
                          nil t))))
#+end_src
**** DISABLED go-guru
#+begin_src emacs-lisp
  (use-package go-guru
    :straight t)
#+end_src
* Font and Theme
** Fonts
SourceCodePro is my default font.
Execute ~(print (font-family-list))~ to get a list of all available fonts and how
Emacs expects you to write them.

#+BEGIN_SRC emacs-lisp
  ;; Turn off antialiasing for BigBlue Terminal Font
  ;; (setq mac-allow-anti-aliasing nil)

  (defun hbournis/update-font ()
    "Re-set the font and font size according to the platform."
    (if (member hbournis/default-font (font-family-list))
        (cond (IS-MAC
               (set-face-attribute 'default nil :font (concat hbournis/default-font "-" hbournis/mac-font-size)))
              (IS-LINUX
               (set-face-attribute 'default nil :font (concat hbournis/default-font "-" hbournis/alternate-font-size)))
              (IS-WINDOWS
               (set-face-attribute 'default nil :font (concat hbournis/default-font "-" hbournis/windows-font-size) :weight 'semi-bold)))

      (cond (IS-WINDOWS
             (set-face-attribute 'default nil :font (concat hbournis/fallback-font "-" hbournis/windows-font-size)))
            (t (set-face-attribute 'default nil :font (concat hbournis/fallback-font "-" hbournis/mac-font-size)))))

    ;; Set a font with great support for Unicode Symbols to fallback in
    ;; those case where certain Unicode glyphs are missing in the current
    ;; font.
    (when (member hbournis/unicode-font (font-family-list))
      (cond (IS-MAC
             (set-fontset-font t 'unicode (concat hbournis/unicode-font "-" hbournis/mac-font-size) nil 'prepend))
            (IS-LINUX
             (set-fontset-font t 'unicode (concat hbournis/unicode-font "-" hbournis/mac-font-size) nil 'prepend))
            (IS-WINDOWS
             (set-fontset-font t 'unicode (concat hbournis/unicode-font "-" hbournis/windows-font-size) nil 'prepend))))
    )

  (hbournis/update-font)
#+END_SRC
** Themes
*** new color theme
#+begin_src emacs-lisp
  (defun hbournis/load-dark-theme ()
    "Load the specified dark theme.  It uses the variables dark-theme-var, dark-theme-modeline-var.
        Also sets some faces for org-checkbox, strings, org TODO items and evil mode cursors. "

    (use-package doom-themes
      :straight t
      :config
      (use-package all-the-icons
        :straight t)
      (setq doom-themes-enable-bold t
            doom-themes-enable-italic t
            doom-themes-treemacs-line-spacing 2
            doom-themes-treemacs-theme "doom-colors")
      (doom-themes-treemacs-config))

    (load-theme 'modus-vivendi t)

    (set-face-attribute 'line-number nil
                        :background "#000000")
    (set-face-attribute 'vertical-border nil
                        :background "#000000"
                        :foreground "#000000")
    (set-face-attribute 'mode-line-inactive nil
                        :box nil
                        :background "#000000")
    (set-face-attribute 'mode-line nil
                        :box nil)
    (set-face-attribute 'fringe nil
                        :background 'unspecified)
    (set-face-attribute 'font-lock-comment-face nil :foreground "#7D7F81" )
    (set-face-attribute 'font-lock-string-face nil :background "#050505" )
    (set-face-attribute 'font-lock-keyword-face nil :background "#050505" ))

  (defun hbournis/load-light-theme ()
    (use-package flatui-theme
      :straight t)

    (load-theme 'flatui t)

    (set-face-attribute 'font-lock-string-face nil
                        :background nil
                        :foreground "#0a74b9")
    (set-face-attribute 'line-number nil
                        :background "#ecf0f1")
    (set-face-attribute 'mode-line nil
                        :background "#dfe4ea"
                        :box nil)
    (set-face-attribute 'mode-line-inactive nil
                        :box nil
                        :background "#ecf0f1"))

  (hbournis/load-dark-theme)

  (run-with-idle-timer 0.2 nil (lambda () (load "~/.dotfiles/emacs.d.symlink/lisp/custom-modeline")))
#+end_src
* Custom Functions
** DISABLED set-face-attribute
#+begin_src emacs-lisp
  (defun set-face-attribute (&rest attributes)
    (if (facep (car attributes))
        (apply 'set-face-attribute attributes)))
#+end_src
** Call with prefix
#+begin_src emacs-lisp
  (defun hbournis/call-with-prefix (func &optional prefix)
    (interactive)
    (let ((current-prefix-arg (or prefix '(1))))
      (call-interactively func)))
#+end_src
** Toggle Window Split
Toggle between horizontal and vertical split. [[https://www.emacswiki.org/emacs/ToggleWindowSplit][Source]]

#+BEGIN_SRC emacs-lisp
  (defun toggle-window-split ()
    ;; Toggle the placement of windows between horizontal and vertical split
    (interactive)
    (if (= (count-windows) 2)
        (let* ((this-win-buffer (window-buffer))
         (next-win-buffer (window-buffer (next-window)))
         (this-win-edges (window-edges (selected-window)))
         (next-win-edges (window-edges (next-window)))
         (this-win-2nd (not (and (<= (car this-win-edges)
             (car next-win-edges))
               (<= (cadr this-win-edges)
             (cadr next-win-edges)))))
         (splitter
          (if (= (car this-win-edges)
           (car (window-edges (next-window))))
        'split-window-horizontally
      'split-window-vertically)))
    (delete-other-windows)
    (let ((first-win (selected-window)))
      (funcall splitter)
      (if this-win-2nd (other-window 1))
      (set-window-buffer (selected-window) this-win-buffer)
      (set-window-buffer (next-window) next-win-buffer)
      (select-window first-win)
      (if this-win-2nd (other-window 1))))))
#+END_SRC
** Align org mode tags on the right
I want to align the org mode tags on the right of the screen, which is a
relative value. However, org-align-all-tags depends on the org-tags-column variable.
For some reason setting org-tags-column in the init file does not work. Although the code
is valid, when I check the value of the variable it is -80. However, if evaluate
the block and check again, the value is set correctly. At the moment I see no
workaround except to set org-tags-column immediatelly before calling
org-align-all-tags. This also means that it will be relative to the window
width at the moment I want to align them, and not at startup.

#+BEGIN_SRC emacs-lisp
  (defun org-align-all-tags-right ()
    ;; Align org tags to the right of the screen. Calculates it according to the
    ;; window-total-width property.
    (interactive)
    (setq org-tags-column (+ 5 (- (window-total-width))))
    (org-align-all-tags))
#+END_SRC
** Copy to clipboard
#+begin_src emacs-lisp
  (defun hbournis/copy-to-clipboard (string)
    (kill-new string)
    (message (concat "Copied to clipboard: " string)))
#+end_src
** Copy file name to clipboard
#+begin_src emacs-lisp
  (defun hbournis/copy-filename-to-clipboard ()
    (interactive)
    (hbournis/copy-to-clipboard (format "%s" buffer-file-name)))
#+end_src
** Check if cliboard data is a URL
Helper function for ~hbournis/insert-url-as-org-link~ and
~hbournis/org-make-word-link-from-clipboard.~ Returns true if url is a valid
URL. Returns false if it is not a URL, or if it is an org-mode formatted link.

#+BEGIN_SRC emacs-lisp
  (defun hbournis/cliboard-contains-url-p (url)
    ;; Returns true if url is a valid URL. Returns false
    ;; if it is not a URL, or if it is an org-mode formatted
    ;; link.
    (let ((url-pattern  "\\(http[s]?://\\|www\\.\\)")
          (url-org-pattern "\\([[]+\\)"))
      (and (not (string-match url-org-pattern url)) (string-match url-pattern url))))
#+END_SRC
** Paste URL from clipboard in org mode format
Insert a URL from clipboard in org mode format and place the cursor in insert
mode to complete the link text. Originally seen [[https://emacs.stackexchange.com/a/3287][here]]. The original snippet
matched URLs that were already formatted as org mode links, leading to really
broken links being inserted. This is a common case since when you delete a link
it is stored in the register. I added a second regular expression that checks
whether the URL in the clipboard starts with ~[~.

#+BEGIN_SRC emacs-lisp
  (defun hbournis/insert-url-as-org-link ()
    "If there's a URL on the clipboard, insert it as an org-mode
  link in the form of [[url][*]], leave point at * and enter insert mode."
    (interactive)
    (let ((link (substring-no-properties (x-get-selection 'CLIPBOARD))))
      (save-match-data
        (if (hbournis/cliboard-contains-url-p link)
            (progn
              (insert (concat "[[" link "][]]"))
              (backward-char 2)
              (evil-insert 1))
          (error "No URL on the clipboard")))))
#+END_SRC
** Paste URL from clipboard using the word at point as link text
Takes the word that the cursor in on, and replaces it with an org-mode link to
the URL in the clipboard. If there is no word at the cursor point, it inserts
the link with the URL as text. Returns an error if there is no URL at the
clipboard. I wanted to make it work with visual selection, but I maybe in the
future.

#+BEGIN_SRC emacs-lisp
  (defun hbournis/org-make-word-link-from-clipboard ()
    ;; Takes the word that the cursor in on, and replaces it with an org-mode
    ;; link to the URL in the clipboard. If there is no word at the cursor point,
    ;; it inserts the link with the URL as text. Returns an error if there is
    ;; no URL at the clipboard.
    (interactive)
    (let ((link (substring-no-properties (x-get-selection 'CLIPBOARD)))
          ;; Specify the bounds of the region in order to delete it
          (bounds (if (use-region-p)
                      (cons (region-beginning) (region-end))
                    (bounds-of-thing-at-point 'symbol)))
          ;; If there is no word at point, then use the link as URL
          (text (or (thing-at-point 'symbol) link)))

      ;; Check if link is a URL and that it is not already in org mode format,
      ;; else throw an error
      (if (hbournis/cliboard-contains-url-p link)
          (progn
            ;; If bounds exist, delete the word to replace it with the link
            (if bounds
                (delete-region (car bounds) (cdr bounds)))

            ;; Insert the link with the text in org mode link format
            (insert (concat "[[" link "][" text "]]")))
        (error "There is no URL at the clipboard."))))
#+END_SRC
** Copy to clipboard link to current file and current line
#+BEGIN_SRC emacs-lisp
  (defun hbournis-position-to-kill-ring ()
    "Copy to the kill ring a string in the format \"file-name:line-number\"
      for the current buffer's file name, and the line number at point.
      Originally seen: https://stackoverflow.com/a/10682397"
    (interactive)
    (let ((linum (save-restriction (widen) (line-number-at-pos))))
      (kill-new
       (format "[[file:%s::%d][⮴\"%s\":%d]]"
               (buffer-file-name)
               linum
               (file-name-nondirectory (buffer-file-name))
               linum))
      (message "Copied link to position")))
#+END_SRC
** Smartparens wrap-with- functions
For each pair character, generate a function called ~wrap-with-<pair name>~. [[https://ebzzry.io/en/emacs-pairs/][Source]]
#+BEGIN_SRC emacs-lisp
  ;; Source: https://ebzzry.io/en/emacs-pairs/
  (defmacro def-pairs (pairs)
    `(progn
       ,@(cl-loop for (key . val) in pairs
                  collect
                  `(defun ,(read (concat
                                  "wrap-with-"
                                  (prin1-to-string key)
                                  "s"))
                       (&optional arg)
                     (interactive "p")
                     (sp-wrap-with-pair ,val)))))

  (def-pairs ((paren . "(")
              (bracket . "[")
              (brace . "{")
              (single-quote . "'")
              (double-quote . "\"")
              (back-quote . "`")))
#+END_SRC
** Transform org date to simple year-month-day string
#+BEGIN_SRC emacs-lisp
  (defun hbournis/org-date-to-simple-string (date)
    "Transform an org date to a simple year-month-day format"
    (substring (format "%S" date) 1 11))
#+END_SRC
** Recreate scratch buffer
A simple function from [[https://www.emacswiki.org/emacs/RecreateScratchBuffer][Emacs wiki]] to recreate the scratch buffer

#+BEGIN_SRC emacs-lisp
  (defun hbournis/create-scratch-buffer nil
    "create a scratch buffer"
    (interactive)
    (switch-to-buffer (get-buffer-create "*scratch*"))
    (lisp-interaction-mode))
#+END_SRC
** Hide ^M in files with DOS line endings
[[https://stackoverflow.com/a/750933][Source]]

#+BEGIN_SRC emacs-lisp
  (defun remove-dos-eol ()
    "Do not show ^M in files containing mixed UNIX and DOS line endings."
    (interactive)
    (setq buffer-display-table (make-display-table))
    (aset buffer-display-table ?\^M []))
#+END_SRC
** DISABLED org-fancy-priorities development
For development only.
#+BEGIN_SRC emacs-lisp
  (if (file-exists-p (concat user-emacs-directory "lisp/org-fancy-priorities/org-fancy-priorities.el"))
      (progn
        (add-to-list 'load-path "~/.emacs.d/lisp/org-fancy-priorities/")
        (require 'org-fancy-priorities)
        (setq org-fancy-priorities-list '((?A . "❗")
                                          (?B . "⬆")
                                          (?C . "⬇")
                                          (?D . "☕")
                                          (?1 . "❗")
                                          (?2 . "⮬")
                                          (?3 . "⮮")
                                          (?4 . "☠")))
        (add-hook 'org-mode-hook 'org-fancy-priorities-mode)
        (diminish 'org-fancy-priorities-mode)))
#+END_SRC
** Terminal Notifier
[[https://zhongweiy.github.io/blog/2016/02/03/solve-error-emacs-not-compiled-with-dbus-support/][Source]]

#+BEGIN_SRC emacs-lisp
  ;; Terminal notifier
  ;; requires 'brew install terminal-notifier'
  ;; stolen from erc-notifier

  (defvar terminal-notifier-command (executable-find "terminal-notifier") "The path to terminal-notifier.")

  ;; (terminal-notifier-notify "Emacs notification" "Something amusing happened")

  (defun terminal-notifier-notify (title message)
    "Show a message with
  terminal-notifier-command
  ."
    (start-process "terminal-notifier"
                   "terminal-notifier"
                   terminal-notifier-command
                   "-title" title
                   "-message" message
                   "-sound" "default"
                   "-activate" "org.gnu.Emacs"))

  (defun timed-notification (time msg)
    (interactive "sNotification when (e.g: 2 minutes, 60 seconds, 3 days): \nsMessage: ")
    (run-at-time time nil (lambda (msg) (terminal-notifier-notify "Emacs" msg)) msg))

  (setq org-show-notification-handler
        (lambda (msg) (timed-notification nil msg)))
#+END_SRC
** DISABLED Refresh agenda when files change on disk
#+BEGIN_SRC emacs-lisp
  (defun inform-revert-modified-file (&optional p1 p2)
    "bdimych custom function"
    (let ((revert-buffer-function nil))
      (revert-buffer p1 p2)
      (message (concat "buffer file name is: " buffer-file-name))
      ;; (if (member buffer-file-name)
      ;;     )
      (if (get-buffer "*Org Agenda*")
          (with-current-buffer "*Org Agenda*"
            (org-agenda-redo)))))

  (setq revert-buffer-function 'inform-revert-modified-file)
#+END_SRC
** Delete empty sections in org agenda
[[https://lists.gnu.org/archive/html/emacs-orgmode/2015-06/msg00266.html][Source]]

#+BEGIN_SRC emacs-lisp
  (defun org-agenda-delete-empty-blocks ()
    "Remove empty agenda blocks.
  A block is identified as empty if there are fewer than 2
  non-empty lines in the block (excluding the line with
  `org-agenda-block-separator' characters)."
    (when org-agenda-compact-blocks
      (user-error "Cannot delete empty compact blocks"))
    (setq buffer-read-only nil)
    (save-excursion
      (goto-char (point-min))
      (let* ((blank-line-re "^\\s-*$")
             (content-line-count (if (looking-at-p blank-line-re) 0 1))
             (start-pos (point))
             (block-re (format "%c\\{10,\\}" org-agenda-block-separator)))
        (while (and (not (eobp)) (forward-line))
          (cond
           ((looking-at-p block-re)
            (when (< content-line-count 2)
              (delete-region start-pos (1+ (point-at-bol))))
            (setq start-pos (point))
            (forward-line)
            (setq content-line-count (if (looking-at-p blank-line-re) 0 1)))
           ((not (looking-at-p blank-line-re))
            (setq content-line-count (1+ content-line-count)))))
        (when (< content-line-count 2)
          (delete-region start-pos (point-max)))
        (goto-char (point-min))
        ;; The above strategy can leave a separator line at the beginning
        ;; of the buffer.
        (when (looking-at-p block-re)
          (delete-region (point) (1+ (point-at-eol))))))
    (setq buffer-read-only t))

  (add-hook 'org-agenda-finalize-hook #'org-agenda-delete-empty-blocks)
#+END_SRC
** Open file in an external program
[[http://batsov.com/articles/2011/11/12/emacs-tip-number-2-open-file-in-external-program/][Source]]

#+BEGIN_SRC emacs-lisp
  (defun prelude-open-with ()
    "Simple function that allows us to open the underlying
  file of a buffer in an external program."
    (interactive)
    (when buffer-file-name
      (shell-command (concat
                      (if (eq system-type 'darwin)
                          "open"
                        (read-shell-command "Open current file with: "))
                      " "
                      buffer-file-name))))

  (global-set-key (kbd "C-c o") 'prelude-open-with)
#+END_SRC
** Insert current time stamp
Just a simple function for when I want the current time stamp inside an org file

#+BEGIN_SRC emacs-lisp
  (defun hbournis/insert-timestamp ()
    "Inserts inactive timestamp with time"
    (interactive)
    (newline-and-indent)
    (insert "⏱⏱⏱ --- ")
    (org-insert-time-stamp (current-time) t t)
    (insert " --- ⏱⏱⏱\n------------------------------------------")
    (newline-and-indent))
#+END_SRC
** kill-window-and-its-windows
[[https://www.emacswiki.org/emacs/misc-cmds.el][Source]]

#+BEGIN_SRC emacs-lisp
  ;; Candidate as a replacement for `kill-buffer', at least when used interactively.
  ;; For example: (define-key global-map [remap kill-buffer] 'kill-buffer-and-its-windows)
  ;;
  ;; We cannot just redefine `kill-buffer', because some programs count on a
  ;; specific other buffer taking the place of the killed buffer (in the window).
  (defun kill-buffer-and-its-windows (buffer)
    "Kill BUFFER and delete its windows.  Default is `current-buffer'.
  BUFFER may be either a buffer or its name (a string)."
    (interactive (list (read-buffer "Kill buffer: " (current-buffer) 'existing)))
    (setq buffer  (get-buffer buffer))
    (if (buffer-live-p buffer)            ; Kill live buffer only.
        (let ((wins  (get-buffer-window-list buffer nil t))) ; On all frames.
          (when (and (buffer-modified-p buffer)
                     (fboundp '1on1-flash-ding-minibuffer-frame))
            (1on1-flash-ding-minibuffer-frame t)) ; Defined in `oneonone.el'.
          (when (kill-buffer buffer)      ; Only delete windows if buffer killed.
            (dolist (win  wins)           ; (User might keep buffer if modified.)
              (when (window-live-p win)
                ;; Ignore error, in particular,
                ;; "Attempt to delete the sole visible or iconified frame".
                (condition-case nil (delete-window win) (error nil))))))
      (when (interactive-p)
        (error "Cannot kill buffer.  Not a live buffer: `%s'" buffer))))
#+END_SRC
** toggle modeline

#+BEGIN_SRC emacs-lisp
  (defun hbournis/toggle-modeline ()
    "Show/hide modeline"
    (interactive)
    (if (get 'hbournis/toggle-modeline 'modeline-status)
        (progn
          (setq mode-line-format (get 'hbournis/toggle-modeline 'modeline-status))
          (put 'hbournis/toggle-modeline 'modeline-status nil))
      (progn
        (put 'hbournis/toggle-modeline 'modeline-status mode-line-format)
        (setq mode-line-format nil)))
    (redraw-frame))
#+END_SRC
** Split and switch to new frame
#+BEGIN_SRC emacs-lisp
  (defun split-window-horizontally-and-switch ()
    (interactive)
    (split-window-horizontally)
    (other-window 1))

  (defun split-window-vertically-and-switch ()
    (interactive)
    (split-window-vertically)
    (other-window 1))

  (defun split-window-below-and-switch ()
    (interactive)
    (split-window-below)
    (other-window 1))

  (defun split-window-right-and-switch ()
    (interactive)
    (split-window-right)
    (other-window 1))
#+END_SRC
** Copy file name to clipboard
 [[https://stackoverflow.com/a/2417617][Source]]
#+BEGIN_SRC emacs-lisp
(defun my-put-file-name-on-clipboard ()
  "Put the current file name on the clipboard"
  (interactive)
  (let ((filename (if (equal major-mode 'dired-mode)
                      default-directory
                    (buffer-file-name))))
    (when filename
      (with-temp-buffer
        (insert filename)
        (clipboard-kill-region (point-min) (point-max)))
      (message filename))))
#+END_SRC
** dired create file
[[https://stackoverflow.com/a/18885461][Source]]

#+BEGIN_SRC emacs-lisp
  (defun hbournis/dired-create-file (file)
    "Create a file called FILE. If FILE already exists, signal an error."
    (interactive
     (list (read-file-name "Create file: " (dired-current-directory))))
    (let* ((expanded (expand-file-name file))
           (try expanded)
           (dir (directory-file-name (file-name-directory expanded)))
           new)
      (if (file-exists-p expanded)
          (error "Cannot create file %s: file exists" expanded))
      ;; Find the topmost nonexistent parent dir (variable `new')
      (while (and try (not (file-exists-p try)) (not (equal new try)))
        (setq new try
              try (directory-file-name (file-name-directory try))))
      (when (not (file-exists-p dir))
        (make-directory dir t))
      (write-region "" nil expanded t)
      (when new
        (dired-add-file new)
        (dired-move-to-filename))))
#+END_SRC
** ssh
:PROPERTIES:
:VISIBILITY: folded
:END:
*** ssh to osmc
#+begin_src emacs-lisp
(defun hbournis/ssh-ranger-omsc ()
  "open ranger through ssh to local osmc"
  (interactive)
  (ranger "/scp:osmc:~"))
#+end_src
** read-only .log files
#+begin_src emacs-lisp
(add-to-list 'auto-mode-alist '("\\.log\\'" . read-only-mode))
#+end_src
** Tail current ranger file
Run itail on the currently highlighted file in ranger.

#+begin_src emacs-lisp
  (defun hbournis/tail-file-at-point ()
    "Run itail on the current ranger file."
    (interactive)
    (let ((file-path (ranger-copy-absolute-file-paths)))
      (itail file-path)))
#+end_src
** Open org-file if not at work
#+begin_src emacs-lisp
  (defun hbournis/open-org-file (file)
    "Open org file conditionally. Avoid opening them by mistake."
    (cond ((not WORK?)
           (find-file file))
          ((and WORK? (eq file hbournis/org-work-file)) (find-file file))))
#+end_src
** Call Language-function according to file_extension
#+begin_src emacs-lisp
  (setq hbournis/test-at-point-map
        #s(hash-table size 6 test eq data (
                                           rspec-mode      rspec-verify-single
                                           minitest-mode   minitest-verify-single
                                           js-mode         mocha-test-at-point
                                           typescript-mode jest-test-run-at-point
                                           web-mode        mocha-test-at-point
                                           clojure-mode    cider-test-run-test)))

  (setq hbournis/test-file-map
        #s(hash-table size 6 test eq data (
                                           rspec-mode      rspec-verify
                                           minitest-mode   minitest-verify
                                           js-mode         mocha-test-file
                                           typescript-mode jest-test-run
                                           web-mode        mocha-test-file
                                           clojure-mode    cider-test-run-ns-tests)))

  (setq hbournis/test-all-map
        #s(hash-table size 6 test eq data (
                                           rspec-mode      rspec-verify-all
                                           ruby-mode       rspec-verify-all
                                           minitest-mode   minitest-verify-all
                                           js-mode         mocha-test-project
                                           typescript-mode jest-test-run-all-tests
                                           web-mode        mocha-test-project
                                           clojure-mode    cider-test-run-project-tests)))

  (setq hbournis/find-definition-map
        #s(hash-table size 2 test eq data (
                                           ruby-mode       lsp-find-definition
                                           typescript-mode lsp-find-definition
                                           java-mode       dumb-jump-go
                                           web-mode        dumb-jump-go)))

  (setq hbournis/open-doc-map
        #s(hash-table size 3 test eq data (
                                           rspec-mode      robe-doc
                                           minitest-mode   robe-doc
                                           clojure-mode    cider-doc)))

  (setq hbournis/show-repl-map
        #s(hash-table size 1 test eq data (
                                           clojure-mode    cider-switch-to-repl-buffer)))

  (defun hbournis/get-generic-lookup-mode ()
    (let ((is-ruby (eq major-mode 'ruby-mode))
          (filename (buffer-file-name)))
      (if is-ruby
          (cond ((string-match-p ".*_spec\\.rb" filename) 'rspec-mode)
                ((string-match-p ".*_test\\.rb" filename) 'minitest-mode)
                (t 'ruby-mode))
        major-mode)))

  (defun hbournis/call-interactively-generic-func (map)
    (if-let ((result (gethash (hbournis/get-generic-lookup-mode) map)))
        (call-interactively result)))

  (defun hbournis/generic-run-test-at-point ()
    "Call the appropriate run test at point function depending on major mode."
    (interactive)
    (hbournis/call-interactively-generic-func hbournis/test-at-point-map))

  (defun hbournis/generic-run-test-file ()
    "Call the appropriate run test file function depending on major mode."
    (interactive)
    (hbournis/call-interactively-generic-func hbournis/test-file-map))

  (defun hbournis/generic-run-test-all ()
    "Call the appropriate run all tests function depending on major mode."
    (interactive)
    (hbournis/call-interactively-generic-func hbournis/test-all-map))

  (defun hbournis/generic-find-definition ()
    "Call the appropriate run all tests function depending on major mode."
    (interactive)
    (hbournis/call-interactively-generic-func hbournis/find-definition-map))

  (defun hbournis/generic-open-doc ()
    "Show the function documentation depending on major mode."
    (interactive)
    (hbournis/call-interactively-generic-func hbournis/open-doc-map))

  (defun hbournis/generic-show-repl ()
    "Show the repl depending on major mode."
    (interactive)
    (hbournis/call-interactively-generic-func hbournis/show-repl-map))
#+end_src
** TDD mode
#+begin_src emacs-lisp
  (defun hbournis/ruby-test-file-p (&optional file)
    "Returns true if file is a ruby spec file"
    (interactive)
    (let ((filename (or file (buffer-file-name)))
          (ruby-test-suffix "spec.rb"))
      (string-suffix-p ruby-test-suffix filename)))

  (defun hbournis/tdd-split ()
    "Split screen for TDD"
    (interactive)
    (let ((current-file (buffer-file-name))
          (spec-name (rspec-spec-file-for (buffer-file-name)))
          (file-name (rspec-target-file-for (buffer-file-name))))
      (delete-other-windows)
      (if (hbournis/ruby-test-file-p current-file)
          (projectile-rails-find-current-spec))
      (split-window-horizontally)
      (projectile-rails-find-current-spec)
      (hbournis/generic-run-test-file)
      (other-window 1)
      (split-window-below-and-switch)
      (find-file file-name)
      (other-window 1)))
#+end_src
** Kill all buffers except those starting with asterisk
#+begin_src emacs-lisp
  (defun hbournis/kill-buffer-unless-asterisk (buffer)
    "Returns true if the buffer should be killed."
    (unless (string-prefix-p "*" (buffer-name buffer))
      (kill-buffer buffer)))

  (defun hbournis/kill-all-file-buffers ()
    "Kill all buffers if unless they start with asterisk."
    (interactive)
    (mapcar 'hbournis/kill-buffer-unless-asterisk (buffer-list))
    (message "File Buffers killed."))
#+end_src
** DISABLED magit recent branches mine
#+begin_src emacs-lisp
  (defun hbournis/magit-insert-recent-branches nil
    "Insert recent branches to magit."
    (let* ((git-command "git recents")
           (recents (-filter 's-present? (split-string (shell-command-to-string git-command) "\n")))
           (local-branches (magit-refs--format-local-branches))
           (recent-local-branches (-filter
                                   (lambda (e) (--find (string-equal e (-first-item it)) local-branches))
                                   recents)))

      (magit-insert-section (rb "rb")
        (magit-insert-heading "Recent branches")
        (dolist (it-branch recent-local-branches)
          (let ((output (magit-rev-format "%h %s" it-branch)))
            (string-match "^\\([^ ]+\\) \\(.*\\)" output)
            (magit-bind-match-strings (commit summary) output
              (when (and t (equal summary ""))
                (setq summary "(no commit message)"))
              (magit-insert-section (branch it-branch t)
                (insert (propertize commit
                                    'font-lock-face 'magit-hash) ?\s)
                (insert (propertize it-branch
                                    'font-lock-face 'magit-branch-local) ?\s)
                (insert (funcall magit-log-format-message-function
                                 it-branch summary) ?\n))
              )))
        (insert  ?\n))
      ))

    (magit-add-section-hook 'magit-status-sections-hook 'exp-feat/magit-insert-recent-branches 'magit-insert-unpulled-from-upstream)
#+end_src
** Increase/decrease font size
#+begin_src emacs-lisp
  (defun hbournis/transform-font-size (transform-function &optional amount)
    "Increment font size by."
    (let ((amount (if amount amount 1)))
      (mapcar (lambda (variable)
                (let* ((current-value (string-to-number (symbol-value variable)))
                       (new-value (apply transform-function `(,current-value ,amount))))
                  (set variable (number-to-string new-value))
                  (message "Font Size: %s" new-value)
                  (hbournis/update-font)
                  (symbol-value variable)))
              '(hbournis/mac-font-size hbournis/windows-font-size hbournis/alternate-font-size))))

  (defun hbournis/increment-font-size (&optional amount)
    "Increment font size by AMOUNT."
    (interactive)
    (hbournis/transform-font-size '+ amount))

  (defun hbournis/decrement-font-size (&optional amount)
    "Increment font size by AMOUNT."
    (interactive)
    (hbournis/transform-font-size '- amount))
#+end_src
** Switch to tab
#+begin_src emacs-lisp
  (defun hbournis/switch-to-or-create-tab (name)
    (if (hbournis/tab-exists-p name)
        (tab-bar-switch-to-tab name)
      (progn
        (tab-bar-new-tab)
        (tab-bar-rename-tab name))))
#+end_src
** Write file
#+begin_src emacs-lisp
  (defun hbournis/write-file (filename content)
    "Write content to file."
    (with-temp-file filename (insert content)))
#+end_src
* Shortcuts
global shortcuts

#+BEGIN_SRC emacs-lisp
  (global-set-key   (kbd "C-c w")  'browser-url-at-point)
  (global-unset-key (kbd "C-k"))
  (global-unset-key (kbd "C-S-k"))
  (global-set-key   (kbd "C-S-k")  (lambda () (interactive) (kill-this-buffer) (delete-other-windows)))
  (global-set-key   (kbd "C-c a")  'org-agenda)
#+END_SRC
* ENV variables

#+BEGIN_SRC emacs-lisp
  ;; For pdf-tools to work in mac
  (setenv "PKG_CONFIG_PATH" "/usr/local/Cellar/zlib/1.2.8/lib/pkgconfig:/usr/local/lib/pkgconfig:/opt/X11/lib/pkgconfig")

  (setenv "PATH" (concat (getenv "PATH") ":/usr/local/bin"))
#+END_SRC
* Start emacs server
Start an emacs server so you can open files from the command line using
emacsclient

#+BEGIN_SRC emacs-lisp
  (require 'server)
  (unless (server-running-p)
    (server-start))

  ;; (require 'org-protocol)
#+END_SRC
* DISABLED Autostart Org Agenda
Reload all agenda files before before showing the agenda, since they might
have been edited from the mobile app.

If eyebrowse is installed, switch to the 1st window config, to avoid overriding
the last opened window config.

#+BEGIN_SRC emacs-lisp
  (setq initial-buffer-choice (lambda ()
                                (dolist (file-name org-agenda-files)
                                  (let ((buf (find-buffer-visiting file-name)))
                                    (if buf
                                        (with-current-buffer buf
                                          (when (buffer-file-name)
                                            (revert-buffer :ignore-auto :noconfirm))))))

                                (hbournis/switch-to-or-create-tab "1")

                                (if WORK?
                                    (org-agenda nil "w")
                                  (org-agenda nil "c"))
                                (get-buffer "*Org Agenda*")
                                (beginning-of-buffer)
                                (get-buffer "*Org Agenda*")))

  (delete-other-windows)
#+END_SRC
* DISABLED Start fullscreen
#+BEGIN_SRC emacs-lisp
  (add-to-list 'default-frame-alist '(fullscreen . maximized))
#+END_SRC

* Cleanup startup
#+begin_src emacs-lisp
  (setq debug-on-error nil)

  ;; after started up, reset GC threshold to normal.
  (run-with-idle-timer 4 nil
                       (lambda ()
                         "Clean up gc."
                         (setq gc-cons-threshold (* 16 1024 1024)
                               gc-cons-percentage 0.1)
                         (garbage-collect)))
#+end_src
